<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Checklist - TESTING VERSION</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/SiteLogo.png">
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="css/styles.css" rel="stylesheet">
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 15px rgba(0, 0, 0, 0.15), 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg-color);
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.2rem;
        }

        h1.glow-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .lead {
            font-size: 1.1rem;
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        .btn {
            border-radius: 0.75rem;
            padding: 0.625rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-info {
            background: var(--info-gradient);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(245, 87, 108, 0.3);
        }

        .alert {
            border-radius: 1rem;
            border: none;
            box-shadow: var(--card-shadow);
            padding: 1.25rem 1.5rem;
        }

        .alert-secondary {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(90, 98, 104, 0.1) 100%);
            color: var(--text-color);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
            border-left: 4px solid #4facfe;
            color: var(--text-color);
        }

        .form-control, .form-select {
            border-radius: 0.75rem;
            border: 2px solid var(--card-border);
            padding: 0.625rem 1rem;
            transition: var(--transition);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.375rem;
            border: 2px solid var(--card-border);
            transition: var(--transition);
            cursor: pointer;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .form-check-input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-check-label {
            cursor: pointer;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .stock-calc-container {
            min-width: 200px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid rgba(102, 126, 234, 0.15);
        }

        .stock-target-input {
            text-align: right;
            font-weight: 600;
        }

        .stock-needed-display-checklist {
            text-align: center;
            padding: 0.5rem;
            min-height: 20px;
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%);
            border-radius: 0.5rem;
            font-weight: 600;
            color: #11998e;
            margin-top: 0.5rem;
        }

        .time-display {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            border: 1px solid rgba(102, 126, 234, 0.2);
            font-weight: 600;
        }

        .text-info {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .text-warning {
            background: var(--warning-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .business-item {
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(102, 126, 234, 0.02) 100%);
            border: 1px solid rgba(102, 126, 234, 0.15);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .business-item:hover {
            transform: translateX(4px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .business-code {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .business-name {
            font-weight: 600;
            color: var(--text-color);
        }

        small.text-muted {
            opacity: 0.7;
            font-weight: 500;
        }

        hr {
            opacity: 0.2;
            margin: 1.25rem 0;
        }

        .spinner-border {
            border-color: #667eea;
            border-right-color: transparent;
        }

        .config-panel {
            margin-bottom: 2rem;
        }

        .config-collapse-btn {
            width: 100%;
            text-align: left;
            font-weight: 600;
        }

        .modal-content {
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .conversion-display {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .conversion-toggle {
            cursor: pointer;
            user-select: none;
        }

        .emoji-picker-container {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .emoji-search {
            margin-bottom: 1rem;
        }

        .emoji-search input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--card-border);
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .emoji-search input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .emoji-category {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--card-border);
        }

        .emoji-category:first-child {
            margin-top: 0;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .emoji-btn.hidden {
            display: none;
        }

        .emoji-category.hidden {
            display: none;
        }

        .emoji-btn {
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover {
            background-color: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: scale(1.1);
        }

        kbd {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            font-size: 0.875rem;
            font-weight: 700;
            line-height: 1;
            color: var(--text-color);
            text-align: center;
            background-color: var(--bg-color);
            border: 1px solid var(--card-border);
            border-radius: 0.25rem;
            box-shadow: inset 0 -1px 0 var(--card-border);
        }

        @media (max-width: 768px) {
            h1.glow-text {
                font-size: 2rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>


    <!-- Main Content -->
    <main class="container py-5">
        <div class="text-center mb-5">
            <h1 class="glow-text">ğŸ“‹ Business Checklist</h1>
            <p class="lead">Track all open businesses across all tiers</p>
        </div>

        <!-- Time Displays -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="time-display">
                                    <strong>ğŸ• Local time:</strong> 
                                    <div id="local-time" class="text-info" style="font-size: 1.2rem; margin-top: 0.5rem;">--:--:--</div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="time-display">
                                    <strong>ğŸ• Eastern Time:</strong> 
                                    <div id="eastern-time" class="text-info" style="font-size: 1.2rem; margin-top: 0.5rem;">--:--:--</div>
                                    <span id="eastern-tz" class="text-muted small">EST</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="time-display">
                                    <strong>ğŸ”„ Server Reboot:</strong> 
                                    <div id="reboot-countdown" class="text-warning" style="font-size: 1.2rem; margin-top: 0.5rem;">--:--:--</div>
                                    <small class="text-muted d-block mt-1">Next: <span id="reboot-time-et">3:00 AM EST</span> / <span id="reboot-time-local">--:--</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How to Use Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header" style="background-color: var(--card-bg); border-bottom: 1px solid var(--card-border);">
                        <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" data-bs-toggle="collapse" data-bs-target="#howToUseCollapse" aria-expanded="true" aria-controls="howToUseCollapse" style="color: var(--text-color); font-weight: 600;">
                            <span>ğŸ“– How to Use This Page</span>
                            <span class="float-end" id="howToUseToggle">â–¼</span>
                        </button>
                    </div>
                    <div class="collapse show" id="howToUseCollapse">
                        <div class="card-body">
                            <div class="mb-3">
                                <h6 class="mb-2"><strong>Step 1: Set Up Your Tiers</strong></h6>
                                <p class="mb-2">Click on <strong>âš™ï¸ Configuration Management</strong> above to expand it, then click <span class="badge bg-primary">â• Add Tier</span> to create your first tier. Give it a name (e.g., "Tier 1: Fruit Stand"), choose an icon (emoji), and select a color.</p>
                                
                                <h6 class="mb-2"><strong>Step 2: Add Products</strong></h6>
                                <p class="mb-2">Before adding businesses, you can set up products for each tier. In the Configuration Management panel, click <span class="badge bg-primary">â• Add Product</span> to create products:</p>
                                <ul class="mb-3">
                                    <li><strong>Tier:</strong> Select which tier this product belongs to (products are tier-specific)</li>
                                    <li><strong>Product Name:</strong> Enter the product name (e.g., "Apple", "Orange", "Banana")</li>
                                </ul>
                                <p class="mb-2"><em>Note:</em> Products help you track which items each business is producing. You can add products at any time, but it's recommended to set them up before adding businesses.</p>
                                
                                <h6 class="mb-2"><strong>Step 3: Add Businesses</strong></h6>
                                <p class="mb-2">In the Configuration Management panel, click <span class="badge bg-primary">â• Add Business</span> to add businesses to your tiers. Fill in:</p>
                                <ul class="mb-3">
                                    <li><strong>Business Code:</strong> A unique identifier (e.g., "TIER1-BIZ001")</li>
                                    <li><strong>Business Name:</strong> The location or name (e.g., "Route 68, Grand Senora Desert")</li>
                                    <li><strong>Tier:</strong> Select which tier this business belongs to</li>
                                    <li><strong>Max Stock:</strong> Maximum stock capacity for this business</li>
                                    <li><strong>Collection Storage:</strong> Maximum collection storage capacity</li>
                                    <li><strong>Notes:</strong> <em>Optional</em> - Add notes to help remember which business this is, such as employee names or other identifying information. Hover over the â„¹ï¸ icon for more details. This makes it easy to identify businesses when you have multiple locations.</li>
                                </ul>
                                
                                <h6 class="mb-2"><strong>Step 4: Track Your Progress</strong></h6>
                                <p class="mb-2">Once businesses are added, they will appear in the checklist below. You can:</p>
                                <ul class="mb-3">
                                    <li><strong>Check off businesses:</strong> Click the checkbox when you've completed a task (checked businesses are excluded from summary calculations)</li>
                                    <li><strong>Add Money:</strong> Enter the current money amount in the Money field</li>
                                    <li><strong>Track Stock:</strong> Enter current stock to see how much more is needed to reach max. The system automatically calculates "Stock Needed" based on Max Stock - Current Stock</li>
                                    <li><strong>Select Product:</strong> Choose which product this business is producing from the Product dropdown. This is used for summary calculations</li>
                                    <li><strong>Track Collection:</strong> Enter collection storage amounts (if applicable)</li>
                                    <li><strong>Add Notes:</strong> Add any notes or reminders for each business</li>
                                </ul>
                                
                                <h6 class="mb-2"><strong>Step 5: View Tier Summaries</strong></h6>
                                <p class="mb-2">Each tier card has a <span class="badge bg-info">ğŸ“Š Show Summary</span> / <span class="badge bg-info">ğŸ“Š Hide Summary</span> button. Click it to view a summary table showing:</p>
                                <ul class="mb-3">
                                    <li><strong>Product Name:</strong> All products assigned to businesses in this tier</li>
                                    <li><strong>Total Products Needed:</strong> Sum of stock needed for each product across all businesses in the tier</li>
                                </ul>
                                <p class="mb-2"><em>Note:</em> Businesses with checked checkboxes are excluded from summary calculations. The summary only counts businesses that need stock.</p>
                                
                                <h6 class="mb-2"><strong>Step 6: View All Business Summary</strong></h6>
                                <p class="mb-2">Below the tier cards, you'll find the <strong>ğŸ“Š All Business Summary</strong> card (appears when products are selected). This shows:</p>
                                <ul class="mb-3">
                                    <li><strong>Product Name:</strong> All products across all tiers</li>
                                    <li><strong>Tier Columns:</strong> Stock needed for each product per tier</li>
                                    <li><strong>Grand Total:</strong> Total stock needed for each product across all tiers</li>
                                    <li><strong>Footer Row:</strong> Grand totals for each tier and overall grand total</li>
                                </ul>
                                <p class="mb-2">This summary helps you see at a glance how much of each product you need across all your businesses.</p>
                                
                                <h6 class="mb-2"><strong>Step 7: Google Sheets Sync (Optional)</strong></h6>
                                <p class="mb-2">You can sync your checklist data to Google Sheets for cloud access across devices:</p>
                                <ul class="mb-3">
                                    <li><strong>Connect:</strong> In the Configuration Management panel, under "Storage Settings", click <span class="badge bg-success">ğŸ”— Connect Google Sheets</span> to sign in with your Google account</li>
                                    <li><strong>Automatic Sync:</strong> Once connected, all changes are automatically synced to Google Sheets (with a 2-second delay to avoid excessive API calls)</li>
                                    <li><strong>Hybrid Storage:</strong> Data is always saved to your browser (localStorage) for offline access. When connected, changes sync to both localStorage and Google Sheets</li>
                                    <li><strong>Disconnect:</strong> Click <span class="badge bg-danger">ğŸ”Œ Disconnect</span> to stop syncing. Your data remains in localStorage</li>
                                    <li><strong>Status:</strong> The status badge shows "Connected" (green), "Syncing..." (yellow), or "Disconnected" (gray)</li>
                                    <li><strong>Last Sync:</strong> The timestamp shows when data was last synced to Google Sheets</li>
                                </ul>
                                <p class="mb-2"><strong>Troubleshooting:</strong></p>
                                <ul class="mb-3">
                                    <li>If sync fails, check your internet connection and try disconnecting and reconnecting</li>
                                    <li>If you see "Token expired", disconnect and reconnect to refresh authentication</li>
                                    <li>Your data is always safe in localStorage even if Google Sheets sync fails</li>
                                    <li>If you lose access to your Google account, you can still use localStorage and export/import your configuration</li>
                                </ul>
                                
                                <h6 class="mb-2"><strong>Step 8: Import/Export Configuration</strong></h6>
                                <p class="mb-2">You can backup and restore your configuration (including tiers, businesses, products, and product selections):</p>
                                <ul class="mb-3">
                                    <li><strong>Export:</strong> Click <span class="badge bg-success">ğŸ“¤ Export Configuration</span> to copy your setup. Then copy the JSON text:</li>
                                    <ul class="mb-2">
                                        <li><strong>Windows/Linux:</strong> Press <kbd>Ctrl</kbd> + <kbd>A</kbd> then <kbd>Ctrl</kbd> + <kbd>C</kbd></li>
                                        <li><strong>Mac:</strong> Press <kbd>Cmd</kbd> + <kbd>A</kbd> then <kbd>Cmd</kbd> + <kbd>C</kbd></li>
                                    </ul>
                                    <li><strong>Import:</strong> Click <span class="badge bg-warning">ğŸ“¥ Import Configuration</span>, then paste your saved JSON:</li>
                                    <ul class="mb-2">
                                        <li><strong>Windows/Linux:</strong> Press <kbd>Ctrl</kbd> + <kbd>V</kbd></li>
                                        <li><strong>Mac:</strong> Press <kbd>Cmd</kbd> + <kbd>V</kbd></li>
                                    </ul>
                                    <li>Click <span class="badge bg-primary">Import</span> to load your configuration</li>
                                </ul>
                                <p class="mb-0">All your progress is automatically saved to your browser. Use <span class="badge bg-info">ğŸ“‹ Generate Checklist</span> to create a CSV report (includes product information). For more details on copy/paste shortcuts, see the <a href="merchants.html">Traveling Merchants</a> page.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Panel -->
        <div class="card config-panel">
            <div class="card-header">
                <button class="btn btn-link config-collapse-btn text-decoration-none text-white" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse" aria-expanded="false" aria-controls="configCollapse">
                    âš™ï¸ Configuration Management <span class="float-end">â–¼</span>
                </button>
            </div>
            <div class="collapse" id="configCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <h5>Tier Management</h5>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-primary" onclick="openAddTierModal()">â• Add Tier</button>
                            <button type="button" class="btn btn-info" onclick="openEditTierModal()">âœï¸ Edit Tier</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Business Management</h5>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-primary" onclick="openAddBusinessModal()">â• Add Business</button>
                            <button type="button" class="btn btn-info" onclick="openEditBusinessModal()">âœï¸ Edit Business</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Product Management</h5>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-primary" onclick="openAddProductModal()">â• Add Product</button>
                            <button type="button" class="btn btn-info" onclick="openEditProductModal()">âœï¸ Edit Product</button>
                            <button type="button" class="btn btn-secondary" onclick="openProductOrderModal()">ğŸ“‹ Edit Product Order</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Storage Settings</h5>
                        <div class="mb-2">
                            <p class="mb-2">Sync your data to Google Sheets for cloud access across devices.</p>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span>Status:</span>
                                <span id="googleSheetsStatus" class="badge bg-secondary">Disconnected</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <button type="button" class="btn btn-success" id="connectGoogleSheetsBtn" onclick="authenticateGoogle()">ğŸ”— Connect Google Sheets</button>
                                <button type="button" class="btn btn-danger" id="disconnectGoogleSheetsBtn" onclick="disconnectGoogleSheets()" style="display: none;">ğŸ”Œ Disconnect</button>
                            </div>
                            <small id="lastSyncTime" class="text-muted">Never synced</small>
                        </div>
                        <div class="alert alert-info alert-sm mb-0" role="alert">
                            <small><strong>Note:</strong> Data is always saved to your browser (localStorage) for offline access. When connected to Google Sheets, changes are automatically synced to the cloud. You can disconnect at any time and continue using localStorage.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Import/Export</h5>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-success" onclick="exportConfiguration()">ğŸ“¤ Export Configuration</button>
                            <button type="button" class="btn btn-warning" onclick="openImportModal()">ğŸ“¥ Import Configuration</button>
                            <button type="button" class="btn btn-info" onclick="generatePersonTableString()">ğŸ“‹ Generate Checklist</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-secondary" role="alert" id="loadingAlert">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Loading businesses from localStorage...
        </div>

        <!-- Dynamic Content Container -->
        <div id="checklistContainer">
            <!-- Content will be dynamically generated here -->
        </div>

        <!-- Summary -->
        <div class="alert alert-info mt-4" role="alert" id="summaryAlert" style="display: none;">
            <h5 class="alert-heading" style="font-weight: 700; font-size: 1.3rem; margin-bottom: 1rem;">ğŸ“Š Summary</h5>
            <p class="mb-0" id="summaryContent" style="font-size: 1.05rem; line-height: 1.8;">
                <!-- Summary will be dynamically generated here -->
            </p>
        </div>

        <!-- All Business Summary -->
        <div class="card mt-4" id="allBusinessSummaryCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“Š All Business Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr id="allBusinessSummaryHeaderRow">
                                <th>Product Name</th>
                                <!-- Tier columns will be dynamically generated here -->
                                <th class="text-end"><strong>Grand Total</strong></th>
                            </tr>
                        </thead>
                        <tbody id="allBusinessSummaryBody">
                            <tr>
                                <td colspan="100%" class="text-center text-muted">Loading summary...</td>
                            </tr>
                        </tbody>
                        <tfoot id="allBusinessSummaryFooter">
                            <!-- Grand Total row will be dynamically generated here -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary" onclick="checkAll()">âœ… Check All</button>
            <button type="button" class="btn btn-secondary" onclick="uncheckAll()">âŒ Uncheck All</button>
            <button type="button" class="btn btn-info" onclick="saveProgress()">ğŸ’¾ Save Progress</button>
            <button type="button" class="btn btn-danger" onclick="clearProgress()">ğŸ—‘ï¸ Clear Progress</button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="debugToggleBtn" onclick="toggleDebug()">
                <span id="debugToggleText">ğŸ” Debug: OFF</span>
            </button>
        </div>
    </main>

    <!-- Tier Modal -->
    <div class="modal fade" id="tierModal" tabindex="-1" aria-labelledby="tierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tierModalLabel">Add/Edit Tier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="tierForm">
                        <input type="hidden" id="tierId" value="">
                        <div class="mb-3">
                            <label for="tierName" class="form-label">Tier Name</label>
                            <input type="text" class="form-control" id="tierName" required placeholder="e.g., Tier 1: Fruit Stand">
                        </div>
                        <div class="mb-3">
                            <label for="tierIcon" class="form-label">Icon (Emoji)</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="tierIcon" placeholder="e.g., ğŸ" maxlength="2">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleEmojiPicker()" title="Show emoji picker">
                                    ğŸ˜€
                                </button>
                            </div>
                            <div id="emojiPicker" class="emoji-picker-container" style="display: none;">
                                <div class="emoji-search">
                                    <input type="text" id="emojiSearchInput" placeholder="ğŸ” Search emojis..." oninput="filterEmojis()">
                                </div>
                                <div id="emojiGridContainer">
                                    <div class="emoji-category" data-category="special">â­ Special</div>
                                    <div class="emoji-grid" data-category="special">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¨')" title="Koala" data-category="special" data-search="koala">ğŸ¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ´')" title="Horse" data-category="special" data-search="horse">ğŸ´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ‘¨')" title="Dad" data-category="special" data-search="dad father">ğŸ‘¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ™')" title="Luna" data-category="special" data-search="luna moon">ğŸŒ™</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšš')" title="Truck" data-category="special" data-search="Truck">ğŸšš</button>
                                    </div>
                                    <div class="emoji-category" data-category="food">ğŸ” Food & Drink</div>
                                    <div class="emoji-grid" data-category="food">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ')" title="Apple">ğŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŠ')" title="Orange">ğŸŠ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ')" title="Banana">ğŸŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ‡')" title="Grapes">ğŸ‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Strawberry">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Kiwi">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ‰')" title="Watermelon">ğŸ‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜•')" title="Coffee">â˜•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸµ')" title="Tea">ğŸµ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”')" title="Burger">ğŸ”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ­')" title="Hot Dog">ğŸŒ­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ®')" title="Taco">ğŸŒ®</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¯')" title="Burrito">ğŸŒ¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•')" title="Pizza">ğŸ•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—')" title="Chicken">ğŸ—</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–')" title="Meat on Bone">ğŸ–</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ°')" title="Cake">ğŸ°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§')" title="Cupcake">ğŸ§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª')" title="Cookie">ğŸª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ©')" title="Donut">ğŸ©</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥¤')" title="Drink">ğŸ¥¤</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸº')" title="Beer">ğŸº</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ·')" title="Wine">ğŸ·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥‚')" title="Cheers">ğŸ¥‚</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŸ')" title="Fish">ğŸŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¦')" title="Shrimp">ğŸ¦</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¦')" title="Lobster">ğŸ¦</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¦€')" title="Crab">ğŸ¦€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥©')" title="Meat">ğŸ¥©</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥“')" title="Bacon">ğŸ¥“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¾')" title="Wheat">ğŸŒ¾</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ½')" title="Corn">ğŸŒ½</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥•')" title="Carrot">ğŸ¥•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥”')" title="Potato">ğŸ¥”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥¬')" title="Leafy Green">ğŸ¥¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥’')" title="Cucumber">ğŸ¥’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥‘')" title="Avocado">ğŸ¥‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ')" title="Bread">ğŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Croissant">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥¨')" title="Pretzel">ğŸ¥¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§€')" title="Cheese">ğŸ§€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥š')" title="Egg">ğŸ¥š</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥›')" title="Milk">ğŸ¥›</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Pancakes">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§‡')" title="Waffle">ğŸ§‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥¯')" title="Bagel">ğŸ¥¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥–')" title="Baguette">ğŸ¥–</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥ª')" title="Sandwich">ğŸ¥ª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥™')" title="Stuffed Flatbread">ğŸ¥™</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§†')" title="Falafel">ğŸ§†</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥˜')" title="Shallow Pan of Food">ğŸ¥˜</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ²')" title="Pot of Food">ğŸ²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ±')" title="Bento Box">ğŸ±</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ˜')" title="Rice Cracker">ğŸ˜</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ™')" title="Rice Ball">ğŸ™</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Cooked Rice">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›')" title="Curry Rice">ğŸ›</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸœ')" title="Steaming Bowl">ğŸœ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ')" title="Spaghetti">ğŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ ')" title="Roasted Sweet Potato">ğŸ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¢')" title="Oden">ğŸ¢</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ£')" title="Sushi">ğŸ£</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¤')" title="Fried Shrimp">ğŸ¤</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Fish Cake">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥®')" title="Moon Cake">ğŸ¥®</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¡')" title="Dango">ğŸ¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥Ÿ')" title="Dumpling">ğŸ¥Ÿ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥ ')" title="Fortune Cookie">ğŸ¥ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥¡')" title="Takeout Box">ğŸ¥¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§ˆ')" title="Butter">ğŸ§ˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§‚')" title="Salt">ğŸ§‚</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥œ')" title="Peanuts">ğŸ¥œ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ°')" title="Chestnut">ğŸŒ°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¯')" title="Honey Pot">ğŸ¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥„')" title="Spoon">ğŸ¥„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ´')" title="Fork and Knife">ğŸ´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ½ï¸')" title="Fork and Knife with Plate">ğŸ½ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥£')" title="Bowl with Spoon">ğŸ¥£</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥ƒ')" title="Tumbler Glass">ğŸ¥ƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§ƒ')" title="Beverage Box">ğŸ§ƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§‰')" title="Mate">ğŸ§‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§Š')" title="Ice">ğŸ§Š</button>
                                    </div>
                                    <div class="emoji-category" data-category="buildings">ğŸ¢ Buildings & Places</div>
                                    <div class="emoji-grid" data-category="buildings">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª')" title="Store">ğŸª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¬')" title="Department Store">ğŸ¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ­')" title="Factory">ğŸ­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¢')" title="Office">ğŸ¢</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¨')" title="Hotel">ğŸ¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¦')" title="Bank">ğŸ¦</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Hospital">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ«')" title="School">ğŸ«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Graduation Cap">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ°')" title="Castle">ğŸ°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¯')" title="Japanese Castle">ğŸ¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›ï¸')" title="Building">ğŸ›ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›ª')" title="Church">â›ª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•Œ')" title="Mosque">ğŸ•Œ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•')" title="Synagogue">ğŸ•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›•')" title="Temple">ğŸ›•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ï¸')" title="Construction">ğŸ—ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš§')" title="Construction Sign">ğŸš§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›ï¸')" title="Pick">â›ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”¨')" title="Hammer">ğŸ”¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âš’ï¸')" title="Hammer and Pick">âš’ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ› ï¸')" title="Hammer and Wrench">ğŸ› ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”©')" title="Nut and Bolt">ğŸ”©</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âš™ï¸')" title="Gear">âš™ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§°')" title="Toolbox">ğŸ§°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”§')" title="Wrench">ğŸ”§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸªš')" title="Saw">ğŸªš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª“')" title="Axe">ğŸª“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª£')" title="Bucket">ğŸª£</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§±')" title="Brick">ğŸ§±</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸªµ')" title="Wood">ğŸªµ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª¨')" title="Rock">ğŸª¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ ')" title="House">ğŸ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¡')" title="House with Garden">ğŸ¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ˜ï¸')" title="Houses">ğŸ˜ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšï¸')" title="Derelict House">ğŸšï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›º')" title="Tent">â›º</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•ï¸')" title="Camping">ğŸ•ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–ï¸')" title="Beach">ğŸ–ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸï¸')" title="Desert Island">ğŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸœï¸')" title="Desert">ğŸœï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ†')" title="Cityscape at Dusk">ğŸŒ†</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ‡')" title="Sunset">ğŸŒ‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒƒ')" title="Night with Stars">ğŸŒƒ</button>
                                    </div>
                                    <div class="emoji-category" data-category="vehicles">ğŸš— Vehicles</div>
                                    <div class="emoji-grid" data-category="vehicles">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš—')" title="Car">ğŸš—</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš•')" title="Taxi">ğŸš•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš™')" title="SUV">ğŸš™</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Van">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›»')" title="Pickup Truck">ğŸ›»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšš')" title="Truck">ğŸšš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš›')" title="Articulated Lorry">ğŸš›</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšœ')" title="Tractor">ğŸšœ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸï¸')" title="Racing Car">ğŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸï¸')" title="Motorcycle">ğŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›µ')" title="Scooter">ğŸ›µ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš²')" title="Bicycle">ğŸš²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›´')" title="Kick Scooter">ğŸ›´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¹')" title="Skateboard">ğŸ›¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¼')" title="Roller Skate">ğŸ›¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš¢')" title="Ship">ğŸš¢</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›´ï¸')" title="Ferry">â›´ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¥ï¸')" title="Motor Boat">ğŸ›¥ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš¤')" title="Speedboat">ğŸš¤</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›µ')" title="Sailboat">â›µ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âœˆï¸')" title="Plane">âœˆï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›©ï¸')" title="Small Plane">ğŸ›©ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›«')" title="Airplane Departure">ğŸ›«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¬')" title="Airplane Arrival">ğŸ›¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Helicopter">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª‚')" title="Parachute">ğŸª‚</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’º')" title="Seat">ğŸ’º</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšŸ')" title="Suspension Railway">ğŸšŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš ')" title="Mountain Cableway">ğŸš </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš¡')" title="Aerial Tramway">ğŸš¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš€')" title="Rocket">ğŸš€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¸')" title="UFO">ğŸ›¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš‚')" title="Train">ğŸš‚</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšƒ')" title="Railway Car">ğŸšƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš„')" title="High-Speed Train">ğŸš„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš…')" title="Bullet Train">ğŸš…</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš†')" title="Train">ğŸš†</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš‡')" title="Metro">ğŸš‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšˆ')" title="Light Rail">ğŸšˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš‰')" title="Station">ğŸš‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšŠ')" title="Tram">ğŸšŠ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Monorail">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Mountain Railway">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšŒ')" title="Bus">ğŸšŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Oncoming Bus">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Trolleybus">ğŸš</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš‘')" title="Ambulance">ğŸš‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš’')" title="Fire Engine">ğŸš’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš“')" title="Police Car">ğŸš“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš”')" title="Oncoming Police Car">ğŸš”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš¨')" title="Rotating Light">ğŸš¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›½')" title="Gas">â›½</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›£ï¸')" title="Motorway">ğŸ›£ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¤ï¸')" title="Railway Track">ğŸ›¤ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›¢ï¸')" title="Oil Drum">ğŸ›¢ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›³ï¸')" title="Passenger Ship">ğŸ›³ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš')" title="Bus Stop">ğŸš</button>
                                    </div>
                                    <div class="emoji-category" data-category="business">ğŸ’° Money & Business</div>
                                    <div class="emoji-grid" data-category="business">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’°')" title="Money">ğŸ’°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’´')" title="Yen">ğŸ’´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’µ')" title="Dollar">ğŸ’µ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¶')" title="Euro">ğŸ’¶</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’·')" title="Pound">ğŸ’·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¸')" title="Money with Wings">ğŸ’¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’³')" title="Credit Card">ğŸ’³</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’')" title="Diamond">ğŸ’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’')" title="Ring">ğŸ’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¼')" title="Briefcase">ğŸ’¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§³')" title="Luggage">ğŸ§³</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“Š')" title="Chart">ğŸ“Š</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ˆ')" title="Growth">ğŸ“ˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‰')" title="Decrease">ğŸ“‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‹')" title="Clipboard">ğŸ“‹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“Œ')" title="Pushpin">ğŸ“Œ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Round Pushpin">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¦')" title="Package">ğŸ“¦</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¨')" title="Incoming Envelope">ğŸ“¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“§')" title="Email">ğŸ“§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“®')" title="Postbox">ğŸ“®</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›’')" title="Shopping Cart">ğŸ›’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›ï¸')" title="Shopping Bags">ğŸ›ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›ï¸')" title="Bellhop Bell">ğŸ›ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ·ï¸')" title="Label">ğŸ·ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ«')" title="Ticket">ğŸ«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŸï¸')" title="Admission Tickets">ğŸŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Telephone Receiver">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ ')" title="Fax Machine">ğŸ“ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ª')" title="Closed Mailbox">ğŸ“ª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“«')" title="Open Mailbox">ğŸ“«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¬')" title="Mailbox with Mail">ğŸ“¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“­')" title="Mailbox with No Mail">ğŸ“­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¯')" title="Postal Horn">ğŸ“¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“©')" title="Envelope with Arrow">ğŸ“©</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¤')" title="Outbox Tray">ğŸ“¤</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¥')" title="Inbox Tray">ğŸ“¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Memo">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“„')" title="Document">ğŸ“„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ƒ')" title="Page with Curl">ğŸ“ƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‘')" title="Bookmark Tabs">ğŸ“‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“’')" title="Ledger">ğŸ“’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ““')" title="Notebook">ğŸ““</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“”')" title="Notebook with Decorative Cover">ğŸ“”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“•')" title="Closed Book">ğŸ“•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“—')" title="Green Book">ğŸ“—</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“˜')" title="Blue Book">ğŸ“˜</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“™')" title="Orange Book">ğŸ“™</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“š')" title="Books">ğŸ“š</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“–')" title="Open Book">ğŸ“–</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”–')" title="Bookmark">ğŸ”–</button>
                                    </div>
                                    <div class="emoji-category" data-category="entertainment">ğŸª Entertainment</div>
                                    <div class="emoji-grid" data-category="entertainment">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª')" title="Circus">ğŸª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ­')" title="Theater">ğŸ­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¨')" title="Art">ğŸ¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¬')" title="Movie">ğŸ¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¤')" title="Microphone">ğŸ¤</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§')" title="Headphone">ğŸ§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¼')" title="Musical Score">ğŸ¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¹')" title="Musical Keyboard">ğŸ¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Drum">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ·')" title="Saxophone">ğŸ·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸº')" title="Trumpet">ğŸº</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ»')" title="Violin">ğŸ»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸµ')" title="Music">ğŸµ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¶')" title="Musical Notes">ğŸ¶</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ®')" title="Game">ğŸ®</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•¹ï¸')" title="Joystick">ğŸ•¹ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¯')" title="Target">ğŸ¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ³')" title="Bowling">ğŸ³</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ°')" title="Slot">ğŸ°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ²')" title="Dice">ğŸ²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸƒ')" title="Joker">ğŸƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ€„')" title="Mahjong">ğŸ€„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ´')" title="Playing Cards">ğŸ´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŸï¸')" title="Admission Tickets">ğŸŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ«')" title="Ticket">ğŸ«</button>
                                    </div>
                                    <div class="emoji-category" data-category="technology">ğŸ“± Technology</div>
                                    <div class="emoji-grid" data-category="technology">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“±')" title="Phone">ğŸ“±</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“²')" title="Mobile Phone with Arrow">ğŸ“²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜ï¸')" title="Telephone">â˜ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Telephone Receiver">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“Ÿ')" title="Pager">ğŸ“Ÿ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ ')" title="Fax Machine">ğŸ“ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’»')" title="Computer">ğŸ’»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–¥ï¸')" title="Desktop Computer">ğŸ–¥ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–¨ï¸')" title="Printer">ğŸ–¨ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âŒ¨ï¸')" title="Keyboard">âŒ¨ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–±ï¸')" title="Computer Mouse">ğŸ–±ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–²ï¸')" title="Trackball">ğŸ–²ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¾')" title="Floppy Disk">ğŸ’¾</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¿')" title="Optical Disk">ğŸ’¿</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“€')" title="DVD">ğŸ“€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“º')" title="TV">ğŸ“º</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“»')" title="Radio">ğŸ“»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“·')" title="Camera">ğŸ“·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¸')" title="Camera with Flash">ğŸ“¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¹')" title="Video Camera">ğŸ“¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥')" title="Movie Camera">ğŸ¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¼')" title="Videocassette">ğŸ“¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”')" title="Magnifying Glass">ğŸ”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”')" title="Magnifying Glass Tilted Right">ğŸ”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”§')" title="Tool">ğŸ”§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âš¡')" title="Lightning">âš¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”Œ')" title="Electric Plug">ğŸ”Œ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¡')" title="Light Bulb">ğŸ’¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”¦')" title="Flashlight">ğŸ”¦</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•¯ï¸')" title="Candle">ğŸ•¯ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§¯')" title="Fire Extinguisher">ğŸ§¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª£')" title="Bucket">ğŸª£</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§°')" title="Toolbox">ğŸ§°</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§²')" title="Magnet">ğŸ§²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”¬')" title="Microscope">ğŸ”¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”­')" title="Telescope">ğŸ”­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¡')" title="Satellite">ğŸ“¡</button>
                                    </div>
                                    <div class="emoji-category" data-category="symbols">â­ Symbols & Status</div>
                                    <div class="emoji-grid" data-category="symbols">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â­')" title="Star">â­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒŸ')" title="Glowing Star">ğŸŒŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’«')" title="Dizzy">ğŸ’«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âœ¨')" title="Sparkles">âœ¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”¥')" title="Fire">ğŸ”¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¥')" title="Explosion">ğŸ’¥</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¢')" title="Anger Symbol">ğŸ’¢</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’¯')" title="Hundred Points">ğŸ’¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âœ…')" title="Check Mark">âœ…</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âŒ')" title="Cross Mark">âŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â­•')" title="Heavy Large Circle">â­•</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¯')" title="Target">ğŸ¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸª')" title="Circus Tent">ğŸª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¨')" title="Artist Palette">ğŸ¨</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ†')" title="Trophy">ğŸ†</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥‡')" title="1st Place Medal">ğŸ¥‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥ˆ')" title="2nd Place Medal">ğŸ¥ˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¥‰')" title="3rd Place Medal">ğŸ¥‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ…')" title="Sports Medal">ğŸ…</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–ï¸')" title="Military Medal">ğŸ–ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ‘‘')" title="Crown">ğŸ‘‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’')" title="Ring">ğŸ’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’')" title="Gem">ğŸ’</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”‘')" title="Key">ğŸ”‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ï¸')" title="Old Key">ğŸ—ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ')" title="Gift">ğŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ€')" title="Ribbon">ğŸ€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ï¸')" title="Reminder Ribbon">ğŸ—ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸµï¸')" title="Rosette">ğŸµï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŸï¸')" title="Admission Tickets">ğŸŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ«')" title="Ticket">ğŸ«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–ï¸')" title="Medal">ğŸ–ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ï¸')" title="Reminder Ribbon">ğŸ—ï¸</button>
                                </div>
                                    <div class="emoji-category" data-category="nature">ğŸŒ³ Nature</div>
                                    <div class="emoji-grid" data-category="nature">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ³')" title="Tree">ğŸŒ³</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ²')" title="Evergreen Tree">ğŸŒ²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ´')" title="Palm Tree">ğŸŒ´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ±')" title="Seedling">ğŸŒ±</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¿')" title="Herb">ğŸŒ¿</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ€')" title="Four Leaf Clover">ğŸ€</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸƒ')" title="Leaf">ğŸƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ‚')" title="Fallen Leaf">ğŸ‚</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ')" title="Maple Leaf">ğŸ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¾')" title="Sheaf of Rice">ğŸŒ¾</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ·')" title="Tulip">ğŸŒ·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¹')" title="Rose">ğŸŒ¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒº')" title="Hibiscus">ğŸŒº</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ»')" title="Sunflower">ğŸŒ»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¼')" title="Blossom">ğŸŒ¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¸')" title="Cherry Blossom">ğŸŒ¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ')" title="Globe">ğŸŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ')" title="Globe Americas">ğŸŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ')" title="Globe Asia-Australia">ğŸŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ºï¸')" title="Map">ğŸ—ºï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§­')" title="Compass">ğŸ§­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›°ï¸')" title="Mountain">â›°ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”ï¸')" title="Snow-Capped Mountain">ğŸ”ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ‹')" title="Volcano">ğŸŒ‹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ•ï¸')" title="Camping">ğŸ•ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–ï¸')" title="Beach">ğŸ–ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸœï¸')" title="Desert">ğŸœï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸï¸')" title="Desert Island">ğŸï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒŠ')" title="Water Wave">ğŸŒŠ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ…')" title="Sunrise">ğŸŒ…</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ„')" title="Sunrise Over Mountains">ğŸŒ„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ†')" title="Cityscape at Dusk">ğŸŒ†</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ‡')" title="Sunset">ğŸŒ‡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒƒ')" title="Night with Stars">ğŸŒƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ‰')" title="Bridge at Night">ğŸŒ‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒŒ')" title="Milky Way">ğŸŒŒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ ')" title="Shooting Star">ğŸŒ </button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜€ï¸')" title="Sun">â˜€ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¤ï¸')" title="Sun Behind Small Cloud">ğŸŒ¤ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›…')" title="Sun Behind Cloud">â›…</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¥ï¸')" title="Sun Behind Large Cloud">ğŸŒ¥ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜ï¸')" title="Cloud">â˜ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›ˆï¸')" title="Cloud with Lightning and Rain">â›ˆï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¦ï¸')" title="Sun Behind Rain Cloud">ğŸŒ¦ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ§ï¸')" title="Cloud with Rain">ğŸŒ§ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›ˆï¸')" title="Thunder Cloud and Rain">â›ˆï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â„ï¸')" title="Snowflake">â„ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜ƒï¸')" title="Snowman">â˜ƒï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›„')" title="Snowman Without Snow">â›„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ¨ï¸')" title="Cloud with Snow">ğŸŒ¨ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒ©ï¸')" title="Cloud with Lightning">ğŸŒ©ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒªï¸')" title="Tornado">ğŸŒªï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŒˆ')" title="Rainbow">ğŸŒˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜”')" title="Umbrella with Rain Drops">â˜”</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’§')" title="Droplet">ğŸ’§</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â˜‚ï¸')" title="Umbrella">â˜‚ï¸</button>
                                    </div>
                                    <div class="emoji-category" data-category="documents">ğŸ“„ Documents & Items</div>
                                    <div class="emoji-grid" data-category="documents">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“„')" title="Document">ğŸ“„</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ƒ')" title="Page with Curl">ğŸ“ƒ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‘')" title="Bookmark Tabs">ğŸ“‘</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“Š')" title="Bar Chart">ğŸ“Š</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“ˆ')" title="Chart Increasing">ğŸ“ˆ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‰')" title="Chart Decreasing">ğŸ“‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“‹')" title="Clipboard">ğŸ“‹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Memo">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“Œ')" title="Pushpin">ğŸ“Œ</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Round Pushpin">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Paperclip">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ–‡ï¸')" title="Linked Paperclips">ğŸ–‡ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Straight Ruler">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“')" title="Triangular Ruler">ğŸ“</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('âœ‚ï¸')" title="Scissors">âœ‚ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—‚ï¸')" title="Card Index Dividers">ğŸ—‚ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—ƒï¸')" title="Card File Box">ğŸ—ƒï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—„ï¸')" title="File Cabinet">ğŸ—„ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—‘ï¸')" title="Wastebasket">ğŸ—‘ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§ª')" title="Science">ğŸ§ª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§«')" title="Petri Dish">ğŸ§«</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§¬')" title="DNA">ğŸ§¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”¬')" title="Microscope">ğŸ”¬</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ”­')" title="Telescope">ğŸ”­</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ“¡')" title="Satellite Antenna">ğŸ“¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’‰')" title="Syringe">ğŸ’‰</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ’Š')" title="Pill">ğŸ’Š</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ©¹')" title="Adhesive Bandage">ğŸ©¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ©º')" title="Stethoscope">ğŸ©º</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸšª')" title="Door">ğŸšª</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›ï¸')" title="Bed">ğŸ›ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›‹ï¸')" title="Couch and Lamp">ğŸ›‹ï¸</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš½')" title="Toilet">ğŸš½</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸš¿')" title="Shower">ğŸš¿</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›')" title="Bathtub">ğŸ›</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§´')" title="Lotion Bottle">ğŸ§´</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§·')" title="Safety Pin">ğŸ§·</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§¹')" title="Broom">ğŸ§¹</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§º')" title="Basket">ğŸ§º</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§»')" title="Roll of Paper">ğŸ§»</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§¼')" title="Soap">ğŸ§¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§½')" title="Sponge">ğŸ§½</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ§¯')" title="Fire Extinguisher">ğŸ§¯</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ›’')" title="Shopping Cart">ğŸ›’</button>
                                    </div>
                                    <div class="emoji-category" data-category="landmarks">ğŸ—¼ Landmarks</div>
                                    <div class="emoji-grid" data-category="landmarks">
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—¼')" title="Tokyo Tower">ğŸ—¼</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ—½')" title="Statue of Liberty">ğŸ—½</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('â›²')" title="Fountain">â›²</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¡')" title="Ferris Wheel">ğŸ¡</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸ¢')" title="Roller Coaster">ğŸ¢</button>
                                    <button type="button" class="emoji-btn" onclick="selectEmoji('ğŸŸï¸')" title="Stadium">ğŸŸï¸</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="tierColor" class="form-label">Color Class</label>
                            <select class="form-select" id="tierColor">
                                <option value="bg-primary">Primary</option>
                                <option value="bg-success">Success</option>
                                <option value="bg-warning text-dark">Warning</option>
                                <option value="bg-info">Info</option>
                                <option value="bg-secondary">Secondary</option>
                                <option value="bg-danger">Danger</option>
                                <option value="bg-dark text-white">Dark</option>
                                <option value="bg-light text-dark">Light</option>
                                <option value="bg-white text-dark border">White</option>
                                <option value="bg-primary bg-opacity-75 text-white">Primary (75% opacity)</option>
                                <option value="bg-success bg-opacity-75 text-white">Success (75% opacity)</option>
                                <option value="bg-info bg-opacity-75 text-white">Info (75% opacity)</option>
                                <option value="bg-danger bg-opacity-75 text-white">Danger (75% opacity)</option>
                                <option value="bg-warning bg-opacity-75 text-dark">Warning (75% opacity)</option>
                                <option value="bg-secondary bg-opacity-75 text-white">Secondary (75% opacity)</option>
                                <option value="bg-dark bg-opacity-75 text-white">Dark (75% opacity)</option>
                                <option value="bg-primary bg-opacity-50 text-white">Primary (50% opacity)</option>
                                <option value="bg-success bg-opacity-50 text-white">Success (50% opacity)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTier()">Save Tier</button>
                    <button type="button" class="btn btn-danger" id="deleteTierBtn" onclick="deleteTier()" style="display: none;">Delete Tier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Add/Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId" value="">
                        <div class="mb-3">
                            <label for="productTierId" class="form-label">Tier <span class="text-danger">*</span></label>
                            <select class="form-select" id="productTierId" required>
                                <option value="">Select a tier...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required placeholder="e.g., Apple">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                    <button type="button" class="btn btn-danger" id="deleteProductBtn" onclick="deleteProduct()" style="display: none;">Delete Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Order Modal -->
    <div class="modal fade" id="productOrderModal" tabindex="-1" aria-labelledby="productOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productOrderModalLabel">Edit Product Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Use the up/down buttons to reorder products. Products will appear in this order in Tier Summary and All Business Summary.</p>
                    <div id="productOrderList" class="list-group">
                        <!-- Product order items will be dynamically generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-info" onclick="sortProductsByTier()">Sort by Tier</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductOrder()">Save Order</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetProductOrder()">Reset to Alphabetical</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Modal -->
    <div class="modal fade" id="businessModal" tabindex="-1" aria-labelledby="businessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="businessModalLabel">Add/Edit Business</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="businessForm">
                        <input type="hidden" id="businessCodeOriginal" value="">
                        <div class="mb-3">
                            <label for="businessCode" class="form-label">Business Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="businessCode" required placeholder="e.g., TIER1-BIZ001">
                            <small class="form-text text-muted">Required: A unique identifier for this business</small>
                        </div>
                        <div class="mb-3">
                            <label for="businessName" class="form-label">Business Name</label>
                            <input type="text" class="form-control" id="businessName" required placeholder="e.g., Route 68, Grand Senora Desert">
                        </div>
                        <div class="mb-3">
                            <label for="businessNotes" class="form-label">
                                Notes
                                <span class="text-muted" style="cursor: help;" title="Use this field to remember which business this is, such as employee names or other identifying information. This helps you easily identify businesses when tracking multiple locations." data-bs-toggle="tooltip" data-bs-placement="right">â„¹ï¸</span>
                            </label>
                            <textarea class="form-control" id="businessNotes" rows="2" placeholder="e.g., Employee: John Smith, or Location notes..."></textarea>
                            <small class="form-text text-muted">Optional: Add notes to help remember which business this is (e.g., employee names)</small>
                        </div>
                        <div class="mb-3">
                            <label for="businessTierId" class="form-label">Tier</label>
                            <select class="form-select" id="businessTierId" required>
                                <option value="">Select a tier...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="businessStatus" class="form-label">Status</label>
                            <select class="form-select" id="businessStatus">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="businessMaxStock" class="form-label">Max Stock</label>
                            <input type="text" class="form-control number-input" id="businessMaxStock" value="0" placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label for="businessCollectionStorage" class="form-label">Collection Storage</label>
                            <input type="text" class="form-control number-input" id="businessCollectionStorage" value="0" placeholder="0">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="businessCanCollectItems">
                            <label class="form-check-label" for="businessCanCollectItems">Can Collect Items</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBusiness()">Save Business</button>
                    <button type="button" class="btn btn-danger" id="deleteBusinessBtn" onclick="deleteBusiness()" style="display: none;">Delete Business</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> Importing will replace your current configuration. Make sure to export your current config first!
                    </div>
                    <div class="mb-3">
                        <label for="importTextarea" class="form-label">Paste JSON Configuration:</label>
                        <textarea class="form-control" id="importTextarea" rows="10" placeholder='{"tiers": [...], "businesses": [...]}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="importConfiguration()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export/Person Table Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">Export / Person Table String</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="copyToClipboard('exportTextarea')">ğŸ“‹ Copy to Clipboard</button>
                    </div>
                    <div class="mb-3">
                        <label for="exportTextarea" class="form-label">Generated String:</label>
                        <textarea class="form-control" id="exportTextarea" rows="15" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3">
        <div class="container text-center">
            <p>&copy; 2025-2026 Fire0x Incorporated. The Tycoon is owned and created by OneLonelyDad (Troublesum). All rights reserved.</p>
            <div id="version-display" class="mt-2" style="font-size: 0.875rem; color: #6c757d;">
                <!-- Version will be inserted here by site-config.js -->
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="js/bootstrap.bundle.min.js"></script>
    <!-- Site Configuration & Version Manager -->
    <script src="js/site-config.js"></script>
    <!-- Navbar Manager -->
    <script src="js/navbar.js"></script>
    <!-- Theme JS -->
    <script src="js/theme.js"></script>
    <!-- Number Formatter (optional) -->
    <script>
        // Load number-formatter.js if available
        (function() {
            const script = document.createElement('script');
            script.src = 'js/number-formatter.js';
            script.onerror = function() {
                console.warn('number-formatter.js not found, continuing without it');
            };
            document.head.appendChild(script);
        })();
    </script>
    <!-- Checklist JS -->
    <script>
        // Debug mode flag
        const DEBUG_STORAGE_KEY = 'checklist_debug_enabled';
        let debugEnabled = false;
        
        // Initialize debug mode from storage
        function initDebugMode() {
            const stored = localStorage.getItem(DEBUG_STORAGE_KEY);
            debugEnabled = stored === 'true';
            updateDebugToggleUI();
        }
        
        // Toggle debug mode
        function toggleDebug() {
            debugEnabled = !debugEnabled;
            localStorage.setItem(DEBUG_STORAGE_KEY, debugEnabled.toString());
            updateDebugToggleUI();
            debugLog('Debug mode ' + (debugEnabled ? 'ENABLED' : 'DISABLED'));
        }
        
        // Update debug toggle button UI
        function updateDebugToggleUI() {
            const btn = document.getElementById('debugToggleBtn');
            const text = document.getElementById('debugToggleText');
            if (btn && text) {
                if (debugEnabled) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-warning');
                    text.textContent = 'ğŸ” Debug: ON';
                } else {
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-outline-secondary');
                    text.textContent = 'ğŸ” Debug: OFF';
                }
            }
        }
        
        // Debug logging function
        function debugLog(...args) {
            if (debugEnabled) {
                console.log('[Checklist Debug]', ...args);
            }
        }
        
        // Debug error logging function
        function debugError(...args) {
            if (debugEnabled) {
                console.error('[Checklist Debug]', ...args);
            } else {
                console.error(...args);
            }
        }
        
        // Debug warning logging function
        function debugWarn(...args) {
            if (debugEnabled) {
                console.warn('[Checklist Debug]', ...args);
            }
        }
        
        // localStorage Configuration Data Structure
        const CONFIG_STORAGE_KEY = 'checklistConfigData';
        const CONFIG_VERSION = '1.0.1';
        
        // Google Sheets Storage Keys
        const GOOGLE_SHEET_ID_KEY = 'checklistGoogleSheetId';
        const GOOGLE_ACCESS_TOKEN_KEY = 'googleAccessToken';
        const STORAGE_TYPE_KEY = 'checklistStorageType';
        const LAST_SYNC_KEY = 'checklistLastSync';
        const PROGRESS_STORAGE_KEY = 'businessChecklist';
        
        // Google Sheets Configuration
        // 
        // SETUP INSTRUCTIONS:
        // 1. Go to https://console.cloud.google.com/
        // 2. Create a new project or select an existing one
        // 3. Enable the Google Sheets API:
        //    - Go to "APIs & Services" > "Library"
        //    - Search for "Google Sheets API" and enable it
        // 4. Create OAuth 2.0 credentials:
        //    - Go to "APIs & Services" > "Credentials"
        //    - Click "Create Credentials" > "OAuth client ID"
        //    - Application type: "Web application"
        //    - Authorized JavaScript origins: Add your GitHub Pages URL (e.g., https://yourusername.github.io)
        //    - Authorized redirect URIs: Add your GitHub Pages URL (e.g., https://yourusername.github.io)
        //    - Copy the Client ID
        // 5. Create API Key:
        //    - In "Credentials", click "Create Credentials" > "API key"
        //    - Copy the API key
        //    - (Optional) Restrict the API key to Google Sheets API for security
        // 6. Replace the placeholders below with your actual credentials
        //
        const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID_HERE';
        const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY_HERE';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
        
        // Storage state
        let googleSheetsInitialized = false;
        let googleSheetsConnected = false;
        let syncInProgress = false;
        let syncQueue = [];
        let syncDebounceTimer = null;
        
        // Global state
        let checklistConfigData = null;
        
        // Track tier summary visibility
        let tierSummaryVisible = JSON.parse(localStorage.getItem('checklistTierSummaryVisible') || '{}');

        // Initialize configuration from localStorage or migrate from API
        async function initializeConfig() {
            debugLog('=== initializeConfig START ===');
            
            // Initialize Google API (non-blocking)
            if (GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID_HERE' && GOOGLE_API_KEY !== 'YOUR_GOOGLE_API_KEY_HERE') {
                initGoogleAPI().catch(error => {
                    debugError('Failed to initialize Google API:', error);
                });
            }
            
            // Check for existing Google Sheets connection
            const sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
            if (sheetId && googleSheetsInitialized) {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    googleSheetsConnected = true;
                    debugLog('Restored Google Sheets connection');
                }
            }
            
            // Try to load config (will check Google Sheets if connected)
            const loaded = await loadConfigFromLocalStorage();
            if (loaded) {
                if (!loaded.version) {
                    loaded.version = CONFIG_VERSION;
                    await saveConfigToLocalStorage();
                }
                debugLog('âœ… Loaded configuration');
                if (!debugEnabled) console.log('âœ… Loaded configuration');
                debugLog('=== initializeConfig END ===');
                return true;
            }
            
            // No saved config - use default empty config
            checklistConfigData = getDefaultConfig();
            await saveConfigToLocalStorage();
            debugLog('âœ… Created default empty configuration');
            debugLog('=== initializeConfig END ===');
            return true;
        }

        // Load configuration from localStorage (with Google Sheets fallback)
        async function loadConfigFromLocalStorage() {
            debugLog('=== loadConfigFromLocalStorage START ===');
            
            // Try Google Sheets first if connected
            if (googleSheetsConnected) {
                const cloudConfig = await loadConfigFromGoogleSheets();
                if (cloudConfig) {
                    checklistConfigData = cloudConfig;
                    // Also save to localStorage for offline access
                    localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(checklistConfigData));
                    debugLog('âœ… Loaded configuration from Google Sheets');
                    debugLog('=== loadConfigFromLocalStorage END ===');
                    return checklistConfigData;
                }
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem(CONFIG_STORAGE_KEY);
            if (saved) {
                try {
                    checklistConfigData = JSON.parse(saved);
                    debugLog('âœ… Loaded configuration from localStorage');
                    debugLog('=== loadConfigFromLocalStorage END ===');
                    return checklistConfigData;
                } catch (e) {
                    debugError('Error loading config:', e);
                }
            }
            
            debugLog('=== loadConfigFromLocalStorage END ===');
            return null;
        }

        // Save configuration to localStorage (with Google Sheets sync)
        async function saveConfigToLocalStorage() {
            debugLog('=== saveConfigToLocalStorage START ===');
            
            if (checklistConfigData) {
                checklistConfigData.version = CONFIG_VERSION;
                
                // Always save to localStorage first (for offline access)
                localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(checklistConfigData));
                debugLog('âœ… Saved configuration to localStorage');
                
                // Also sync to Google Sheets if connected (hybrid sync)
                if (googleSheetsConnected) {
                    await syncToGoogleSheets();
                }
            }
            
            debugLog('=== saveConfigToLocalStorage END ===');
        }

        // Get default empty configuration structure
        function getDefaultConfig() {
            return {
                tiers: [],
                businesses: [],
                products: [],
                productOrder: [], // Array of product IDs in display order
                version: CONFIG_VERSION
            };
        }

        // ==================== Google Sheets Integration ====================
        
        // Initialize Google API Client
        async function initGoogleAPI() {
            debugLog('=== initGoogleAPI START ===');
            if (googleSheetsInitialized) {
                debugLog('Google API already initialized');
                debugLog('=== initGoogleAPI END ===');
                return true;
            }
            
            try {
                await new Promise((resolve, reject) => {
                    if (typeof gapi === 'undefined') {
                        debugError('Google API (gapi) not loaded');
                        reject(new Error('Google API not loaded'));
                        return;
                    }
                    
                    gapi.load('client:auth2', {
                        callback: () => {
                            debugLog('Google API client loaded');
                            resolve();
                        },
                        onerror: (error) => {
                            debugError('Error loading Google API:', error);
                            reject(error);
                        },
                        timeout: 10000,
                        ontimeout: () => {
                            debugError('Timeout loading Google API');
                            reject(new Error('Timeout loading Google API'));
                        }
                    });
                });
                
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    clientId: GOOGLE_CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                });
                
                googleSheetsInitialized = true;
                debugLog('âœ… Google API initialized successfully');
                
                // Check if user is already signed in
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    googleSheetsConnected = true;
                    debugLog('User already signed in to Google');
                    updateStorageUI();
                }
                
                debugLog('=== initGoogleAPI END ===');
                return true;
            } catch (error) {
                debugError('Error initializing Google API:', error);
                googleSheetsInitialized = false;
                debugLog('=== initGoogleAPI END ===');
                return false;
            }
        }
        
        // Authenticate with Google
        async function authenticateGoogle() {
            debugLog('=== authenticateGoogle START ===');
            
            if (!googleSheetsInitialized) {
                const initialized = await initGoogleAPI();
                if (!initialized) {
                    debugError('Failed to initialize Google API');
                    alert('Failed to initialize Google Sheets. Please check your credentials.');
                    debugLog('=== authenticateGoogle END ===');
                    return false;
                }
            }
            
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                const user = await authInstance.signIn();
                
                if (user.isSignedIn()) {
                    googleSheetsConnected = true;
                    debugLog('âœ… Successfully authenticated with Google');
                    
                    // Create or get sheet
                    const sheetId = await createOrGetSheet();
                    if (sheetId) {
                        localStorage.setItem(GOOGLE_SHEET_ID_KEY, sheetId);
                        updateStorageUI();
                        await syncToGoogleSheets();
                        debugLog('=== authenticateGoogle END ===');
                        return true;
                    } else {
                        debugError('Failed to create or get sheet');
                        alert('Failed to create or access Google Sheet. Please try again.');
                        debugLog('=== authenticateGoogle END ===');
                        return false;
                    }
                } else {
                    debugWarn('User not signed in after authentication attempt');
                    debugLog('=== authenticateGoogle END ===');
                    return false;
                }
            } catch (error) {
                debugError('Error authenticating with Google:', error);
                if (error.error === 'popup_closed_by_user') {
                    alert('Authentication cancelled. Please try again if you want to sync with Google Sheets.');
                } else {
                    alert('Failed to authenticate with Google: ' + (error.error || error.message || 'Unknown error'));
                }
                debugLog('=== authenticateGoogle END ===');
                return false;
            }
        }
        
        // Create or get Google Sheet
        async function createOrGetSheet() {
            debugLog('=== createOrGetSheet START ===');
            
            try {
                // Check if we already have a sheet ID
                let sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
                
                if (sheetId) {
                    // Verify sheet exists and is accessible
                    try {
                        await gapi.client.sheets.spreadsheets.get({
                            spreadsheetId: sheetId
                        });
                        debugLog('âœ… Using existing sheet:', sheetId);
                        debugLog('=== createOrGetSheet END ===');
                        return sheetId;
                    } catch (error) {
                        debugWarn('Existing sheet not accessible, creating new one:', error);
                        sheetId = null;
                    }
                }
                
                // Create new sheet
                const sheetTitle = `Business Checklist - ${new Date().toLocaleDateString()}`;
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: sheetTitle
                    },
                    sheets: [
                        {
                            properties: {
                                title: 'Configuration'
                            }
                        },
                        {
                            properties: {
                                title: 'Progress'
                            }
                        }
                    ]
                });
                
                sheetId = response.result.spreadsheetId;
                debugLog('âœ… Created new Google Sheet:', sheetId);
                
                // Initialize sheet structure
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetId,
                    range: 'Configuration!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['Checklist Configuration Data']]
                    }
                });
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetId,
                    range: 'Progress!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['Checklist Progress Data']]
                    }
                });
                
                debugLog('=== createOrGetSheet END ===');
                return sheetId;
            } catch (error) {
                debugError('Error creating/getting sheet:', error);
                debugLog('=== createOrGetSheet END ===');
                return null;
            }
        }
        
        // Save configuration to Google Sheets
        async function saveConfigToGoogleSheets() {
            debugLog('=== saveConfigToGoogleSheets START ===');
            
            if (!googleSheetsConnected || !checklistConfigData) {
                debugLog('Google Sheets not connected or no config data');
                debugLog('=== saveConfigToGoogleSheets END ===');
                return false;
            }
            
            const sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
            if (!sheetId) {
                debugError('No sheet ID found');
                debugLog('=== saveConfigToGoogleSheets END ===');
                return false;
            }
            
            try {
                const configJson = JSON.stringify(checklistConfigData);
                const configBase64 = btoa(unescape(encodeURIComponent(configJson)));
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetId,
                    range: 'Configuration!A2',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [[configBase64]]
                    }
                });
                
                localStorage.setItem(LAST_SYNC_KEY, new Date().toISOString());
                debugLog('âœ… Saved configuration to Google Sheets');
                updateStorageUI();
                debugLog('=== saveConfigToGoogleSheets END ===');
                return true;
            } catch (error) {
                debugError('Error saving config to Google Sheets:', error);
                if (error.status === 401) {
                    // Token expired, try to refresh
                    debugWarn('Token expired, attempting to refresh');
                    googleSheetsConnected = false;
                    updateStorageUI();
                }
                debugLog('=== saveConfigToGoogleSheets END ===');
                return false;
            }
        }
        
        // Load configuration from Google Sheets
        async function loadConfigFromGoogleSheets() {
            debugLog('=== loadConfigFromGoogleSheets START ===');
            
            if (!googleSheetsConnected) {
                debugLog('Google Sheets not connected');
                debugLog('=== loadConfigFromGoogleSheets END ===');
                return null;
            }
            
            const sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
            if (!sheetId) {
                debugError('No sheet ID found');
                debugLog('=== loadConfigFromGoogleSheets END ===');
                return null;
            }
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: sheetId,
                    range: 'Configuration!A2'
                });
                
                const values = response.result.values;
                if (!values || values.length === 0 || !values[0] || !values[0][0]) {
                    debugLog('No configuration data found in sheet');
                    debugLog('=== loadConfigFromGoogleSheets END ===');
                    return null;
                }
                
                const configBase64 = values[0][0];
                const configJson = decodeURIComponent(escape(atob(configBase64)));
                const config = JSON.parse(configJson);
                
                debugLog('âœ… Loaded configuration from Google Sheets');
                debugLog('=== loadConfigFromGoogleSheets END ===');
                return config;
            } catch (error) {
                debugError('Error loading config from Google Sheets:', error);
                if (error.status === 401) {
                    debugWarn('Token expired');
                    googleSheetsConnected = false;
                    updateStorageUI();
                }
                debugLog('=== loadConfigFromGoogleSheets END ===');
                return null;
            }
        }
        
        // Save progress to Google Sheets
        async function saveProgressToGoogleSheets() {
            debugLog('=== saveProgressToGoogleSheets START ===');
            
            if (!googleSheetsConnected) {
                debugLog('Google Sheets not connected');
                debugLog('=== saveProgressToGoogleSheets END ===');
                return false;
            }
            
            const sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
            if (!sheetId) {
                debugError('No sheet ID found');
                debugLog('=== saveProgressToGoogleSheets END ===');
                return false;
            }
            
            try {
                // Get progress from localStorage first
                const progressJson = localStorage.getItem(PROGRESS_STORAGE_KEY);
                if (!progressJson) {
                    debugLog('No progress data to save');
                    debugLog('=== saveProgressToGoogleSheets END ===');
                    return false;
                }
                
                const progressBase64 = btoa(unescape(encodeURIComponent(progressJson)));
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: sheetId,
                    range: 'Progress!A2',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [[progressBase64]]
                    }
                });
                
                localStorage.setItem(LAST_SYNC_KEY, new Date().toISOString());
                debugLog('âœ… Saved progress to Google Sheets');
                updateStorageUI();
                debugLog('=== saveProgressToGoogleSheets END ===');
                return true;
            } catch (error) {
                debugError('Error saving progress to Google Sheets:', error);
                if (error.status === 401) {
                    debugWarn('Token expired');
                    googleSheetsConnected = false;
                    updateStorageUI();
                }
                debugLog('=== saveProgressToGoogleSheets END ===');
                return false;
            }
        }
        
        // Load progress from Google Sheets
        async function loadProgressFromGoogleSheets() {
            debugLog('=== loadProgressFromGoogleSheets START ===');
            
            if (!googleSheetsConnected) {
                debugLog('Google Sheets not connected');
                debugLog('=== loadProgressFromGoogleSheets END ===');
                return null;
            }
            
            const sheetId = localStorage.getItem(GOOGLE_SHEET_ID_KEY);
            if (!sheetId) {
                debugError('No sheet ID found');
                debugLog('=== loadProgressFromGoogleSheets END ===');
                return null;
            }
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: sheetId,
                    range: 'Progress!A2'
                });
                
                const values = response.result.values;
                if (!values || values.length === 0 || !values[0] || !values[0][0]) {
                    debugLog('No progress data found in sheet');
                    debugLog('=== loadProgressFromGoogleSheets END ===');
                    return null;
                }
                
                const progressBase64 = values[0][0];
                const progressJson = decodeURIComponent(escape(atob(progressBase64)));
                const progress = JSON.parse(progressJson);
                
                debugLog('âœ… Loaded progress from Google Sheets');
                debugLog('=== loadProgressFromGoogleSheets END ===');
                return progress;
            } catch (error) {
                debugError('Error loading progress from Google Sheets:', error);
                if (error.status === 401) {
                    debugWarn('Token expired');
                    googleSheetsConnected = false;
                    updateStorageUI();
                }
                debugLog('=== loadProgressFromGoogleSheets END ===');
                return null;
            }
        }
        
        // Disconnect Google Sheets
        async function disconnectGoogleSheets() {
            debugLog('=== disconnectGoogleSheets START ===');
            
            try {
                if (googleSheetsInitialized) {
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance.isSignedIn.get()) {
                        await authInstance.signOut();
                    }
                }
                
                googleSheetsConnected = false;
                localStorage.removeItem(GOOGLE_SHEET_ID_KEY);
                localStorage.removeItem(LAST_SYNC_KEY);
                updateStorageUI();
                
                debugLog('âœ… Disconnected from Google Sheets');
                debugLog('=== disconnectGoogleSheets END ===');
            } catch (error) {
                debugError('Error disconnecting Google Sheets:', error);
                debugLog('=== disconnectGoogleSheets END ===');
            }
        }
        
        // Get sync status
        function getSyncStatus() {
            return {
                connected: googleSheetsConnected,
                syncing: syncInProgress,
                lastSync: localStorage.getItem(LAST_SYNC_KEY),
                sheetId: localStorage.getItem(GOOGLE_SHEET_ID_KEY)
            };
        }
        
        // Unified sync function with debouncing
        async function syncToGoogleSheets() {
            debugLog('=== syncToGoogleSheets START ===');
            
            if (!googleSheetsConnected) {
                debugLog('Google Sheets not connected, skipping sync');
                debugLog('=== syncToGoogleSheets END ===');
                return false;
            }
            
            // Clear existing debounce timer
            if (syncDebounceTimer) {
                clearTimeout(syncDebounceTimer);
                syncDebounceTimer = null;
            }
            
            // Debounce: wait 2 seconds before syncing
            return new Promise((resolve) => {
                syncDebounceTimer = setTimeout(async () => {
                    syncDebounceTimer = null;
                    
                    if (syncInProgress) {
                        debugLog('Sync already in progress, queuing');
                        syncQueue.push({ type: 'sync', resolve });
                        debugLog('=== syncToGoogleSheets END ===');
                        return;
                    }
                    
                    syncInProgress = true;
                    updateStorageUI();
                    
                    try {
                        // Sync configuration
                        await saveConfigToGoogleSheets();
                        
                        // Sync progress
                        await saveProgressToGoogleSheets();
                        
                        // Process sync queue
                        while (syncQueue.length > 0) {
                            const queued = syncQueue.shift();
                            if (queued && queued.resolve) {
                                queued.resolve(true);
                            }
                        }
                        
                        debugLog('âœ… Sync completed successfully');
                        resolve(true);
                    } catch (error) {
                        debugError('Error during sync:', error);
                        resolve(false);
                    } finally {
                        syncInProgress = false;
                        updateStorageUI();
                        debugLog('=== syncToGoogleSheets END ===');
                    }
                }, 2000);
            });
        }
        
        // Update storage UI
        function updateStorageUI() {
            debugLog('=== updateStorageUI START ===');
            const status = getSyncStatus();
            const statusElement = document.getElementById('googleSheetsStatus');
            const connectBtn = document.getElementById('connectGoogleSheetsBtn');
            const disconnectBtn = document.getElementById('disconnectGoogleSheetsBtn');
            const lastSyncElement = document.getElementById('lastSyncTime');
            
            if (!statusElement || !connectBtn || !disconnectBtn) {
                debugLog('Storage UI elements not found');
                debugLog('=== updateStorageUI END ===');
                return;
            }
            
            if (status.connected) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'badge bg-success';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
                
                if (syncInProgress) {
                    statusElement.textContent = 'Syncing...';
                    statusElement.className = 'badge bg-warning';
                }
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'badge bg-secondary';
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
            }
            
            if (lastSyncElement && status.lastSync) {
                const syncDate = new Date(status.lastSync);
                lastSyncElement.textContent = `Last sync: ${syncDate.toLocaleString()}`;
            } else if (lastSyncElement) {
                lastSyncElement.textContent = 'Never synced';
            }
            
            debugLog('Storage UI updated:', status);
            debugLog('=== updateStorageUI END ===');
        }
        
        // ==================== End Google Sheets Integration ====================

        // Get business tiers (all tiers are visible)
        function getBusinessTiers() {
            if (!checklistConfigData || !checklistConfigData.tiers) return [];
            return checklistConfigData.tiers;
        }

        // Load all businesses from localStorage
        async function loadAllBusinesses() {
            if (!checklistConfigData) {
                debugError('Configuration not initialized');
                await buildChecklist({});
                return;
            }
            
            debugLog('Loading all businesses, total tiers:', getBusinessTiers().length);
            
            // Group businesses by tier
            const businessesByTier = {};
            const tiers = getBusinessTiers();
            
            tiers.forEach(tier => {
                const tierBusinesses = (checklistConfigData.businesses || [])
                    .filter(biz => biz.tierId === tier.id && biz.status === 'Open')
                    .map(biz => ({
                        businessCode: biz.businessCode,
                        businessName: biz.businessName,
                        status: biz.status,
                        tier: tier.name,
                        maxStock: biz.maxStock,
                        collectionStorage: biz.collectionStorage,
                        canCollectItems: biz.canCollectItems,
                        conversionRate: biz.conversionRate || tier.conversionRate,
                        notes: biz.notes || '',
                        productId: biz.productId || null
                    }));
                
                businessesByTier[tier.name] = tierBusinesses;
            });
            
            await buildChecklist(businessesByTier);
        }


        // Build checklist HTML
        async function buildChecklist(businessesByTier) {
            const container = document.getElementById('checklistContainer');
            
            let totalOpen = 0;
            const tierCounts = {};
            const tiers = getBusinessTiers();
            
            // Use DocumentFragment for batch DOM updates to reduce reflows
            const fragment = document.createDocumentFragment();
            
            tiers.forEach(tier => {
                const businesses = businessesByTier[tier.name] || [];
                const openBusinesses = businesses.filter(b => {
                    if (b.status !== 'Open') return false;
                    // Hide businesses with "Placeholder Business Name"
                    const businessName = b.businessName || b.businessCode;
                    return businessName !== 'Placeholder Business Name';
                });
                
                if (openBusinesses.length > 0) {
                    tierCounts[tier.name] = openBusinesses.length;
                    totalOpen += openBusinesses.length;
                    
                    const isSummaryVisible = tierSummaryVisible[tier.name] !== false;
                    
                    const card = document.createElement('div');
                    card.className = 'card mt-4 mb-4';
                    card.innerHTML = `
                        <div class="card-header ${tier.color}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" 
                                           class="form-check-input tier-check-all" 
                                           id="tier-check-all-${tier.name}"
                                           data-tier="${tier.name}"
                                           title="Check/Uncheck all businesses in this tier"
                                           onchange="toggleTierCheckAll('${tier.name}')"
                                           style="width: 1.25rem; height: 1.25rem; cursor: pointer;">
                                    <h2 class="mb-0">${tier.icon} ${tier.name}</h2>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-light toggle-tier-summary-btn" 
                                            data-tier="${tier.name}"
                                            title="Show/Hide Tier Summary"
                                            onclick="toggleTierSummary('${tier.name}')">
                                        ${isSummaryVisible ? 'ğŸ“Š Hide Summary' : 'ğŸ“Š Show Summary'}
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-light toggle-tier-btn" 
                                            data-tier="${tier.name}"
                                            title="Show all businesses in this tier">
                                        ğŸ‘ï¸ Show All
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Tier Summary Section -->
                            <div class="tier-summary-section mb-4" id="tier-summary-${tier.name}" style="display: ${isSummaryVisible ? 'block' : 'none'};">
                                <h5 class="mb-3">ğŸ“Š Tier Summary</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>Product Name</th>
                                                <th>Total Products Needed</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tier-summary-body-${tier.name}">
                                            <tr>
                                                <td colspan="2" class="text-center text-muted">Loading summary...</td>
                                            </tr>
                                        </tbody>
                                        <tfoot id="tier-summary-footer-${tier.name}">
                                            <!-- Grand Total row will be dynamically generated here -->
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="list-group" data-tier="${tier.name}">
                                ${openBusinesses.map((biz, index) => {
                                    const businessName = biz.businessName || biz.businessCode;
                                    const hasCollection = biz.canCollectItems === true;
                                    // Adjust column classes: Money, Stock, Product, Collection (if applicable), Notes
                                    const colClass = hasCollection ? 'col-md-2' : 'col-md-3';
                                    const maxStock = biz.maxStock || 0;
                                    const collectionStorage = biz.collectionStorage || 0;
                                    const maxStockDisplay = maxStock.toLocaleString('en-US');
                                    const collectionDisplay = collectionStorage.toLocaleString('en-US');
                                    const businessNotes = biz.notes || '';
                                    
                                    return `
                                    <div class="business-item" data-business-code="${biz.businessCode}" data-tier="${tier.name}">
                                        <div class="d-flex align-items-start">
                                            <input class="form-check-input me-2 mt-1" type="checkbox" value="${biz.businessCode}" data-tier="${tier.name}" id="check-${tier.name}-${index}">
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div class="flex-grow-1">
                                                    <label class="form-check-label" for="check-${tier.name}-${index}">
                                                            <span class="business-code fw-bold" style="color: var(--primary-color, #667eea);">${biz.businessCode}</span>
                                                            ${businessName && businessName !== biz.businessCode ? `<span class="business-name"> - ${businessName}</span>` : ''}
                                                    </label>
                                                        ${businessNotes ? `
                                                        <div class="mt-1">
                                                            <small class="text-muted" style="font-style: italic; display: block;">
                                                                <span class="text-info">â„¹ï¸</span> ${businessNotes}
                                                            </small>
                                                        </div>
                                                        ` : ''}
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary hide-business-btn" 
                                                            data-business-code="${biz.businessCode}" 
                                                            data-tier="${tier.name}"
                                                            title="Hide business"
                                                            style="border-radius: 0.5rem; padding: 0.25rem 0.5rem;">
                                                        ğŸ‘ï¸
                                                    </button>
                                                </div>
                                                <div class="mt-2 row g-2">
                                                    <div class="${colClass}">
                                                        <small class="text-muted d-block mb-1" style="font-weight: 600;">
                                                            <strong>ğŸ’° Money:</strong>
                                                        </small>
                                                        <input type="text" 
                                                               class="form-control form-control-sm money-input" 
                                                               placeholder="Money" 
                                                               data-tier="${tier.name}" 
                                                               data-business-code="${biz.businessCode}"
                                                               oninput="saveProgress();">
                                                    </div>
                                                    <div class="${colClass}">
                                                        <small class="text-muted d-block mb-1" style="font-weight: 600;">
                                                            <strong>ğŸ“Š Stock (Max):</strong> ${maxStockDisplay}
                                                        </small>
                                                        <div class="stock-calc-container">
                                                            <div class="input-group input-group-sm mb-1">
                                                                <span class="input-group-text" style="font-weight: 600;">Current:</span>
                                                        <input type="text" 
                                                                       class="form-control form-control-sm stock-target-input" 
                                                                       placeholder="0" 
                                                               data-tier="${tier.name}" 
                                                                       data-business-code="${biz.businessCode}"
                                                                       data-max-stock="${maxStock}"
                                                                       max="${maxStock}"
                                                                       oninput="calculateStockNeededChecklist('${tier.name}', '${biz.businessCode}', ${maxStock});">
                                                            </div>
                                                            <div class="stock-needed-display-checklist" 
                                                                 id="stock-needed-${tier.name}-${biz.businessCode}">
                                                                <small class="text-muted">Enter current stock to calculate</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="${colClass}">
                                                        <small class="text-muted d-block mb-1" style="font-weight: 600;">
                                                            <strong>ğŸ“¦ Product:</strong>
                                                        </small>
                                                        <select class="form-select form-select-sm product-selector" 
                                                                data-tier="${tier.name}" 
                                                                data-business-code="${biz.businessCode}"
                                                                onchange="handleProductSelection('${tier.name}', '${biz.businessCode}')">
                                                            <option value="">-- Select Product --</option>
                                                        </select>
                                                    </div>
                                                    ${hasCollection ? `
                                                    <div class="${colClass}">
                                                        <small class="text-muted d-block mb-1" style="font-weight: 600;">
                                                            <strong>ğŸ“¦ Collection:</strong> ${collectionDisplay}
                                                        </small>
                                                        <input type="text" 
                                                               class="form-control form-control-sm collection-input" 
                                                               placeholder="Collection" 
                                                               data-tier="${tier.name}" 
                                                               data-business-code="${biz.businessCode}"
                                                               oninput="saveProgress();">
                                                    </div>
                                                    ` : ''}
                                                    <div class="${hasCollection ? 'col-md-4' : 'col-md-3'}">
                                                        <small class="text-muted d-block mb-1" style="font-weight: 600;">
                                                            <strong>ğŸ“ Notes:</strong>
                                                        </small>
                                                        <textarea class="form-control form-control-sm notes-input" 
                                                                  rows="1" 
                                                                  placeholder="Add notes..." 
                                                                  data-tier="${tier.name}" 
                                                                  data-business-code="${biz.businessCode}"
                                                                  oninput="saveProgress();"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    fragment.appendChild(card);
                }
            });
            
            // Batch DOM update - clear and append fragment in one operation
            container.innerHTML = '';
            container.appendChild(fragment);
            
            // Update summary
            updateSummary(totalOpen, tierCounts);
            
            // Hide loading, show content
            document.getElementById('loadingAlert').style.display = 'none';
            document.getElementById('summaryAlert').style.display = 'block';
            
            // Re-initialize number formatting for dynamically created inputs
            if (typeof initNumberFormatting === 'function') {
                initNumberFormatting({ allowDecimals: true, selector: '.money-input, .stock-input, .collection-input' });
                initNumberFormatting({ allowDecimals: false, selector: '.stock-target-input' });
            }
            
            // Load saved progress
            await loadProgress();
            
            // Populate product selectors for each tier
            debugLog('Starting product selector population and summary calculation');
            tiers.forEach(tier => {
                debugLog(`Populating selectors for tier: ${tier.name}`);
                populateProductSelectorsForTier(tier.name);
            });
            
            // Load product selections (already done in loadProgress, but ensure it happens after selectors are populated)
            setTimeout(() => {
                const productSelectors = document.querySelectorAll('.product-selector');
                debugLog(`Found ${productSelectors.length} product selectors to restore`);
                let restoredCount = 0;
                
                productSelectors.forEach(selector => {
                    const businessCode = selector.dataset.businessCode;
                    const business = (checklistConfigData.businesses || []).find(b => b.businessCode === businessCode);
                    if (business && business.productId) {
                        selector.value = business.productId;
                        restoredCount++;
                        debugLog(`Restored product selection:`, { businessCode, productId: business.productId });
                    }
                });
                debugLog(`âœ… Restored ${restoredCount} product selections from config`);
                
                // Calculate tier summaries after products are loaded
                debugLog(`Calculating summaries for ${tiers.length} tiers`);
                tiers.forEach(tier => {
                    debugLog(`Calculating summary for tier: ${tier.name}`);
                    calculateTierSummary(tier.name);
                });
                
                // Calculate all business summary after all tier summaries are done
                setTimeout(() => {
                    debugLog('Calculating all business summary');
                    calculateAllBusinessSummary();
                }, 200);
            }, 100);
            
            // Update tier toggle buttons after loading
            tiers.forEach(tier => {
                updateTierToggleButton(tier.name);
                // Update tier checkbox states after loading progress
                setTimeout(() => {
                    updateTierCheckboxState(tier.name);
                }, 150);
            });
        }

        // Update summary
        function updateSummary(total, tierCounts) {
            const summaryContent = document.getElementById('summaryContent');
            let summaryHTML = `<strong>Total Open Businesses:</strong> ${total}<br>`;
            
            const tiers = getBusinessTiers();
            tiers.forEach(tier => {
                if (tierCounts[tier.name]) {
                    summaryHTML += `<strong>${tier.name}:</strong> ${tierCounts[tier.name]} business${tierCounts[tier.name] !== 1 ? 'es' : ''}<br>`;
                }
            });
            
            summaryContent.innerHTML = summaryHTML;
        }

        // Check all checkboxes
        function checkAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
            saveProgress();
            
            // Update all tier checkbox states
            const tiers = getBusinessTiers();
            tiers.forEach(tier => {
                updateTierCheckboxState(tier.name);
            });
            
            // Recalculate all tier summaries
            tiers.forEach(tier => {
                calculateTierSummary(tier.name);
            });
        }

        // Uncheck all checkboxes
        function uncheckAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            saveProgress();
            
            // Update all tier checkbox states
            const tiers = getBusinessTiers();
            tiers.forEach(tier => {
                updateTierCheckboxState(tier.name);
            });
            
            // Recalculate all tier summaries
            tiers.forEach(tier => {
                calculateTierSummary(tier.name);
            });
        }

        // Save progress to localStorage (with Google Sheets sync)
        async function saveProgress() {
            debugLog('=== saveProgress START ===');
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const notesInputs = document.querySelectorAll('.notes-input');
            const moneyInputs = document.querySelectorAll('.money-input');
            const stockInputs = document.querySelectorAll('.stock-input');
            const collectionInputs = document.querySelectorAll('.collection-input');
            const progress = {};
            
            // Save checkbox states
            checkboxes.forEach(checkbox => {
                const key = `${checkbox.dataset.tier}::${checkbox.value}`;
                progress[key] = {
                    checked: checkbox.checked,
                    notes: '',
                    money: '',
                    stock: '',
                    collection: ''
                };
            });
            
            // Save notes
            notesInputs.forEach(input => {
                const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                if (progress[key]) {
                    progress[key].notes = input.value;
                } else {
                    progress[key] = {
                        checked: false,
                        notes: input.value,
                        money: '',
                        stock: '',
                        collection: ''
                    };
                }
            });
            
            // Save money
            moneyInputs.forEach(input => {
                const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                if (progress[key]) {
                    progress[key].money = input.value;
                } else {
                    progress[key] = {
                        checked: false,
                        notes: '',
                        money: input.value,
                        stock: '',
                        collection: ''
                    };
                }
            });
            
            // Save stock target
            const stockTargetInputs = document.querySelectorAll('.stock-target-input');
            stockTargetInputs.forEach(input => {
                const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                if (progress[key]) {
                    progress[key].stockTarget = input.value;
                } else {
                    progress[key] = {
                        checked: false,
                        notes: '',
                        money: '',
                        stockTarget: input.value,
                        collection: ''
                    };
                }
            });
            
            // Save collection
            collectionInputs.forEach(input => {
                const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                if (progress[key]) {
                    progress[key].collection = input.value;
                } else {
                    progress[key] = {
                        checked: false,
                        notes: '',
                        money: '',
                        stock: '',
                        collection: input.value
                    };
                }
            });
            
            // Save hidden businesses
            const hiddenBusinesses = [];
            document.querySelectorAll('.business-item[style*="display: none"]').forEach(item => {
                hiddenBusinesses.push(`${item.dataset.tier}::${item.dataset.businessCode}`);
            });
            progress._hidden = hiddenBusinesses;
            
            // Always save to localStorage first (for offline access)
            localStorage.setItem('businessChecklist', JSON.stringify(progress));
            debugLog('âœ… Saved progress to localStorage');
            
            // Also sync to Google Sheets if connected (hybrid sync)
            if (googleSheetsConnected) {
                await syncToGoogleSheets();
            }
            
            debugLog('=== saveProgress END ===');
        }

        // Get note for a business
        function getNote(businessId, tierName) {
            const saved = localStorage.getItem('businessChecklistNotes');
            if (saved) {
                const notes = JSON.parse(saved);
                const key = `${tierName}::${businessId}`;
                return notes[key] || '';
            }
            return '';
        }

        // Save note for a business
        function saveNote(businessId, tierName, note) {
            const saved = localStorage.getItem('businessChecklistNotes');
            const notes = saved ? JSON.parse(saved) : {};
            const key = `${tierName}::${businessId}`;
            if (note && note.trim()) {
                notes[key] = note.trim();
            } else {
                delete notes[key];
            }
            localStorage.setItem('businessChecklistNotes', JSON.stringify(notes));
        }

        // Save note from input field
        function saveNoteFromInput(input) {
            const businessId = input.dataset.businessId;
            const tierName = input.dataset.tier;
            const noteText = input.value;
            saveNote(businessId, tierName, noteText);
        }

        // Load progress from localStorage (with Google Sheets fallback)
        async function loadProgress() {
            debugLog('=== loadProgress START ===');
            
            let progress = null;
            
            // Try Google Sheets first if connected
            if (googleSheetsConnected) {
                const cloudProgress = await loadProgressFromGoogleSheets();
                if (cloudProgress) {
                    progress = cloudProgress;
                    // Also save to localStorage for offline access
                    localStorage.setItem('businessChecklist', JSON.stringify(progress));
                    debugLog('âœ… Loaded progress from Google Sheets');
                }
            }
            
            // Fallback to localStorage
            if (!progress) {
                const saved = localStorage.getItem('businessChecklist');
                if (saved) {
                    progress = JSON.parse(saved);
                    debugLog('âœ… Loaded progress from localStorage');
                }
            }
            
            if (progress) {
                
                // Load checkbox states
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const key = `${checkbox.dataset.tier}::${checkbox.value}`;
                    if (progress[key] !== undefined) {
                        if (typeof progress[key] === 'boolean') {
                            // Legacy format (just boolean)
                        checkbox.checked = progress[key];
                        } else {
                            // New format (object with checked, notes, money, stock)
                            checkbox.checked = progress[key].checked || false;
                        }
                    }
                });
                
                // Load notes
                const notesInputs = document.querySelectorAll('.notes-input');
                notesInputs.forEach(input => {
                    const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                    if (progress[key] && typeof progress[key] === 'object') {
                        if (progress[key].notes !== undefined) {
                            input.value = progress[key].notes;
                        }
                    }
                });
                
                // Load money
                const moneyInputs = document.querySelectorAll('.money-input');
                moneyInputs.forEach(input => {
                    const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                    if (progress[key] && typeof progress[key] === 'object') {
                        if (progress[key].money !== undefined) {
                            input.value = progress[key].money;
                        }
                    }
                });
                
                // Load stock target and calculate
                const stockTargetInputs = document.querySelectorAll('.stock-target-input');
                stockTargetInputs.forEach(input => {
                    const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                    if (progress[key] && typeof progress[key] === 'object') {
                        if (progress[key].stockTarget !== undefined) {
                            input.value = progress[key].stockTarget;
                            // Trigger calculation
                            const maxStock = parseFloat(input.dataset.maxStock) || 0;
                            calculateStockNeededChecklist(input.dataset.tier, input.dataset.businessCode, maxStock);
                        }
                    }
                });
                
                // Load collection
                const collectionInputs = document.querySelectorAll('.collection-input');
                collectionInputs.forEach(input => {
                    const key = `${input.dataset.tier}::${input.dataset.businessCode}`;
                    if (progress[key] && typeof progress[key] === 'object') {
                        if (progress[key].collection !== undefined) {
                            input.value = progress[key].collection;
                        }
                    }
                });
                
                // Load hidden businesses
                if (progress._hidden && Array.isArray(progress._hidden)) {
                    progress._hidden.forEach(key => {
                        const [tier, businessCode] = key.split('::');
                        const item = document.querySelector(`.business-item[data-tier="${tier}"][data-business-code="${businessCode}"]`);
                        if (item) {
                            item.style.display = 'none';
                            const btn = item.querySelector('.hide-business-btn');
                            if (btn) {
                                btn.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                                btn.title = 'Show business';
                            }
                        }
                    });
                }
            }
            
            // Load product selections from business objects
            const productSelectors = document.querySelectorAll('.product-selector');
            let productSelectionRestored = 0;
            productSelectors.forEach(selector => {
                const businessCode = selector.dataset.businessCode;
                const business = (checklistConfigData.businesses || []).find(b => b.businessCode === businessCode);
                if (business && business.productId) {
                    selector.value = business.productId;
                    productSelectionRestored++;
                    debugLog(`Restored product selection in loadProgress:`, { businessCode, productId: business.productId });
                }
            });
            if (productSelectionRestored > 0) {
                debugLog(`âœ… Restored ${productSelectionRestored} product selections in loadProgress`);
            }
            
            debugLog('=== loadProgress END ===');
        }

        // Clear progress
        function clearProgress() {
            if (confirm('Are you sure you want to clear all progress? This will clear checkboxes and notes. This cannot be undone.')) {
                localStorage.removeItem('businessChecklist');
                
                // Uncheck all checkboxes
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                
                // Clear all notes textareas
                const notesInputs = document.querySelectorAll('.notes-input');
                notesInputs.forEach(input => input.value = '');
                
                // Clear all money inputs
                const moneyInputs = document.querySelectorAll('.money-input');
                moneyInputs.forEach(input => input.value = '');
                
                // Clear all stock target inputs
                const stockTargetInputs = document.querySelectorAll('.stock-target-input');
                stockTargetInputs.forEach(input => {
                    input.value = '';
                    const displayId = `stock-needed-${input.dataset.tier}-${input.dataset.businessCode}`;
                    const display = document.getElementById(displayId);
                    if (display) {
                        display.innerHTML = '<small class="text-muted">Enter target to calculate</small>';
                    }
                });
                
                // Clear all collection inputs
                const collectionInputs = document.querySelectorAll('.collection-input');
                collectionInputs.forEach(input => input.value = '');
                
                // Show all hidden businesses
                document.querySelectorAll('.business-item').forEach(item => {
                    item.style.display = '';
                    const btn = item.querySelector('.hide-business-btn');
                    if (btn) {
                        btn.textContent = 'ğŸ‘ï¸';
                        btn.title = 'Hide business';
                    }
                });
            }
        }
        
        // Toggle business visibility
        function toggleBusinessVisibility(button) {
            const businessCode = button.dataset.businessCode;
            const tier = button.dataset.tier;
            const item = document.querySelector(`.business-item[data-tier="${tier}"][data-business-code="${businessCode}"]`);
            
            if (item) {
                if (item.style.display === 'none') {
                    // Show business
                    item.style.display = '';
                    button.textContent = 'ğŸ‘ï¸';
                    button.title = 'Hide business';
                } else {
                    // Hide business
                    item.style.display = 'none';
                    button.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                    button.title = 'Show business';
                }
                saveProgress();
                updateTierToggleButton(tier);
            }
        }
        
        // Toggle all businesses in a tier
        function toggleTierVisibility(tier) {
            const items = document.querySelectorAll(`.business-item[data-tier="${tier}"]`);
            if (items.length === 0) return;
            
            // Check if all are hidden
            const allHidden = Array.from(items).every(item => item.style.display === 'none');
            
            items.forEach(item => {
                const businessCode = item.dataset.businessCode;
                const hideBtn = item.querySelector(`.hide-business-btn[data-business-code="${businessCode}"]`);
                
                if (allHidden) {
                    // Show all
                    item.style.display = '';
                    if (hideBtn) {
                        hideBtn.textContent = 'ğŸ‘ï¸';
                        hideBtn.title = 'Hide business';
                    }
                } else {
                    // Hide all
                    item.style.display = 'none';
                    if (hideBtn) {
                        hideBtn.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                        hideBtn.title = 'Show business';
                    }
                }
            });
            
            saveProgress();
            updateTierToggleButton(tier);
        }
        
        // Toggle all businesses checkboxes in a tier
        function toggleTierCheckAll(tierName) {
            const tierCheckbox = document.getElementById(`tier-check-all-${tierName}`);
            if (!tierCheckbox) {
                debugWarn(`Tier checkbox not found for tier: ${tierName}`);
                return;
            }
            
            const isChecked = tierCheckbox.checked;
            debugLog(`Toggling all businesses in tier ${tierName} to ${isChecked ? 'checked' : 'unchecked'}`);
            
            // Get all business checkboxes in this tier
            const businessCheckboxes = document.querySelectorAll(`input[type="checkbox"][data-tier="${tierName}"]:not(.tier-check-all)`);
            debugLog(`Found ${businessCheckboxes.length} business checkboxes in tier ${tierName}`);
            
            businessCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            // Save progress
            saveProgress();
            
            // Recalculate tier summary
            debugLog(`Recalculating tier summary for ${tierName} after check-all`);
            calculateTierSummary(tierName);
        }
        
        // Update tier checkbox state based on individual business checkboxes
        function updateTierCheckboxState(tierName) {
            const tierCheckbox = document.getElementById(`tier-check-all-${tierName}`);
            if (!tierCheckbox) return;
            
            const businessCheckboxes = document.querySelectorAll(`input[type="checkbox"][data-tier="${tierName}"]:not(.tier-check-all)`);
            if (businessCheckboxes.length === 0) return;
            
            const checkedCount = Array.from(businessCheckboxes).filter(cb => cb.checked).length;
            const allChecked = checkedCount === businessCheckboxes.length;
            const someChecked = checkedCount > 0 && checkedCount < businessCheckboxes.length;
            
            // Update checkbox state (indeterminate if some checked, checked if all checked, unchecked if none checked)
            tierCheckbox.checked = allChecked;
            tierCheckbox.indeterminate = someChecked;
            
            debugLog(`Updated tier checkbox state for ${tierName}:`, { 
                checked: allChecked, 
                indeterminate: someChecked,
                checkedCount,
                totalCount: businessCheckboxes.length 
            });
        }
        
        // Update tier toggle button text/state
        function updateTierToggleButton(tier) {
            const items = document.querySelectorAll(`.business-item[data-tier="${tier}"]`);
            if (items.length === 0) return;
            
            const allHidden = Array.from(items).every(item => item.style.display === 'none');
            const tierBtn = document.querySelector(`.toggle-tier-btn[data-tier="${tier}"]`);
            
            if (tierBtn) {
                if (allHidden) {
                    tierBtn.textContent = 'ğŸ‘ï¸ Show All';
                    tierBtn.title = 'Show all businesses in this tier';
                } else {
                    tierBtn.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸ Hide All';
                    tierBtn.title = 'Hide all businesses in this tier';
                }
            }
        }

        // Auto-save on checkbox or notes change
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' || 
                e.target.classList.contains('notes-input') ||
                e.target.classList.contains('money-input') ||
                e.target.classList.contains('stock-input') ||
                e.target.classList.contains('collection-input')) {
                saveProgress();
                
                // If a business checkbox changed, update tier checkbox state and recalculate tier summary
                if (e.target.type === 'checkbox' && e.target.dataset.tier && !e.target.classList.contains('tier-check-all')) {
                    const tierName = e.target.dataset.tier;
                    debugLog(`Business checkbox changed for tier ${tierName} - updating tier checkbox state and recalculating tier summary`);
                    updateTierCheckboxState(tierName);
                    calculateTierSummary(tierName);
                }
            }
        });
        
        // Auto-save on notes/money/stock/collection input (with debounce for textarea and inputs)
        let inputTimeout;
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('notes-input') ||
                e.target.classList.contains('money-input') ||
                e.target.classList.contains('stock-input') ||
                e.target.classList.contains('collection-input')) {
                clearTimeout(inputTimeout);
                inputTimeout = setTimeout(() => {
                    saveProgress();
                }, 500); // Save 500ms after user stops typing
            }
        });
        
        // Handle hide/show button clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('hide-business-btn')) {
                e.preventDefault();
                toggleBusinessVisibility(e.target);
            } else if (e.target.classList.contains('toggle-tier-btn')) {
                e.preventDefault();
                toggleTierVisibility(e.target.dataset.tier);
            }
        });

        // Format time for a specific timezone
        function formatTimeForTimezone(date, timezone, options = {}) {
            const defaultOptions = {
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return date.toLocaleString('en-US', { ...defaultOptions, ...options });
        }

        // Get Eastern Time zone abbreviation (EDT/EST)
        function getEasternTimeZone() {
            const now = new Date();
            // Create a date in Eastern timezone
            const easternDate = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
            
            // Calculate offset
            const offset = (easternDate.getTime() - utcDate.getTime()) / (1000 * 60 * 60);
            
            // EDT is UTC-4, EST is UTC-5
            return offset === -4 ? 'EDT' : 'EST';
        }

        // Get next 3 AM Eastern Time
        function getNextRebootTime() {
            const now = new Date();
            
            // Get current time in Eastern Timezone
            const easternNowStr = now.toLocaleString('en-US', { 
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            // Parse: "MM/DD/YYYY, HH:MM:SS"
            const [datePart, timePart] = easternNowStr.split(', ');
            const [month, day, year] = datePart.split('/');
            const [hour] = timePart.split(':');
            
            const currentHour = parseInt(hour);
            
            // Determine target date (today or tomorrow)
            let targetYear = parseInt(year);
            let targetMonth = parseInt(month);
            let targetDay = parseInt(day);
            
            // If it's 3 AM or later, target is tomorrow
            if (currentHour >= 3) {
                const date = new Date(targetYear, targetMonth - 1, targetDay);
                date.setDate(date.getDate() + 1);
                targetYear = date.getFullYear();
                targetMonth = date.getMonth() + 1;
                targetDay = date.getDate();
            }
            
            // Find the UTC time that corresponds to 3:00:00 AM Eastern on target date
            // We'll try different UTC times and check which one gives us 3 AM Eastern
            let bestMatch = null;
            
            // Try UTC times from 6 hours before to 6 hours after (Eastern is UTC-4 or UTC-5)
            for (let utcOffset = -6; utcOffset <= 6; utcOffset++) {
                const testUTC = new Date(Date.UTC(targetYear, targetMonth - 1, targetDay, 3 + utcOffset, 0, 0));
                const testEastern = testUTC.toLocaleString('en-US', { 
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                
                const [testDatePart, testTimePart] = testEastern.split(', ');
                const [testMonth, testDay, testYear] = testDatePart.split('/');
                const [testHour] = testTimePart.split(':');
                
                // Check if this UTC time gives us 3 AM Eastern on the correct date
                if (parseInt(testHour) === 3 && 
                    parseInt(testMonth) === targetMonth && 
                    parseInt(testDay) === targetDay && 
                    parseInt(testYear) === targetYear) {
                    bestMatch = testUTC;
                    break;
                }
            }
            
            return bestMatch || new Date(); // Fallback to current time if not found
        }

        // Format countdown time
        function formatCountdown(seconds) {
            if (seconds <= 0) {
                return '00:00:00';
            }
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Update reboot countdown
        function updateRebootCountdown() {
            const now = new Date();
            const nextReboot = getNextRebootTime();
            const diff = Math.floor((nextReboot - now) / 1000);
            
            const countdownElement = document.getElementById('reboot-countdown');
            const rebootTimeETElement = document.getElementById('reboot-time-et');
            const rebootTimeLocalElement = document.getElementById('reboot-time-local');
            
            if (countdownElement) {
                if (diff <= 0) {
                    countdownElement.textContent = '00:00:00';
                    countdownElement.classList.add('text-danger');
                } else {
                    countdownElement.textContent = formatCountdown(diff);
                    countdownElement.classList.remove('text-danger');
                    countdownElement.classList.add('text-warning');
                }
            }
            
            if (rebootTimeETElement) {
                // Format the next reboot time in Eastern - should always be 3:00 AM
                const tz = getEasternTimeZone();
                rebootTimeETElement.textContent = `3:00 AM ${tz}`;
            }
            
            if (rebootTimeLocalElement && nextReboot) {
                // Format the next reboot time in user's local timezone
                const localTimeOptions = {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                };
                const localTime = nextReboot.toLocaleTimeString('en-US', localTimeOptions);
                // Get timezone abbreviation if possible
                const timeZoneName = Intl.DateTimeFormat('en-US', { timeZoneName: 'short' }).formatToParts(nextReboot).find(part => part.type === 'timeZoneName')?.value || '';
                rebootTimeLocalElement.textContent = `${localTime} ${timeZoneName}`;
            }
        }

        // Update navbar times
        function updateTimes() {
            const now = new Date();
            
            // Local time
            const localTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const localTimeElement = document.getElementById('local-time');
            if (localTimeElement) {
                localTimeElement.textContent = localTime;
            }
            
            // Eastern Time
            const easternTime = formatTimeForTimezone(now, 'America/New_York', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const easternElement = document.getElementById('eastern-time');
            const easternTZElement = document.getElementById('eastern-tz');
            if (easternElement) {
                easternElement.textContent = easternTime.split(', ')[1] || easternTime;
            }
            if (easternTZElement) {
                easternTZElement.textContent = getEasternTimeZone();
            }
            
            // Update reboot countdown
            updateRebootCountdown();
        }

        // Auto-save notes on input blur (when user clicks away)
        document.addEventListener('blur', function(e) {
            if (e.target.classList.contains('form-control') && e.target.dataset.businessId) {
                saveNoteFromInput(e.target);
            }
        }, true);

        // Toggle tier summary visibility
        function toggleTierSummary(tierName) {
            const oldState = tierSummaryVisible[tierName];
            if (!tierSummaryVisible.hasOwnProperty(tierName)) {
                tierSummaryVisible[tierName] = true;
            } else {
                tierSummaryVisible[tierName] = !tierSummaryVisible[tierName];
            }
            const newState = tierSummaryVisible[tierName];
            debugLog(`Toggling tier summary:`, { tierName, oldState, newState });
            localStorage.setItem('checklistTierSummaryVisible', JSON.stringify(tierSummaryVisible));
            
            const summarySection = document.getElementById(`tier-summary-${tierName}`);
            const toggleBtn = document.querySelector(`.toggle-tier-summary-btn[data-tier="${tierName}"]`);
            
            if (summarySection) {
                summarySection.style.display = tierSummaryVisible[tierName] ? 'block' : 'none';
            }
            
            if (toggleBtn) {
                toggleBtn.textContent = tierSummaryVisible[tierName] ? 'ğŸ“Š Hide Summary' : 'ğŸ“Š Show Summary';
            }
        }

        // Calculate tier summary
        function calculateTierSummary(tierName) {
            debugLog(`=== calculateTierSummary START for tier: ${tierName} ===`);
            const summaryBody = document.getElementById(`tier-summary-body-${tierName}`);
            if (!summaryBody) {
                debugWarn(`Summary body not found for tier: ${tierName}`);
                return;
            }
            
            // Get all businesses for this tier
            const businesses = document.querySelectorAll(`.business-item[data-tier="${tierName}"]`);
            debugLog(`Found ${businesses.length} businesses for tier ${tierName}`);
            const productMap = {}; // productName -> { totalNeeded: number, businesses: [] }
            
            let checkedCount = 0;
            let skippedCount = 0;
            let processedCount = 0;
            
            businesses.forEach(businessItem => {
                const businessCode = businessItem.dataset.businessCode;
                
                // Check if business checkbox is checked - if checked, ignore this business
                const businessCheckbox = businessItem.querySelector(`input[type="checkbox"][data-tier="${tierName}"][value="${businessCode}"]`);
                if (businessCheckbox && businessCheckbox.checked) {
                    checkedCount++;
                    debugLog(`Business ${businessCode}: Checkbox is checked - skipping from total calculation`);
                    return;
                }
                
                const productSelector = businessItem.querySelector(`.product-selector[data-tier="${tierName}"][data-business-code="${businessCode}"]`);
                const stockNeededDisplay = document.getElementById(`stock-needed-${tierName}-${businessCode}`);
                
                if (!productSelector) {
                    skippedCount++;
                    return;
                }
                
                const selectedOption = productSelector.options[productSelector.selectedIndex];
                if (!selectedOption || !selectedOption.value) {
                    skippedCount++;
                    return;
                }
                
                processedCount++;
                const productName = selectedOption.textContent;
                const productId = selectedOption.value;
                
                // Get stock needed value
                let stockNeeded = 0;
                if (stockNeededDisplay) {
                    const neededText = stockNeededDisplay.textContent || '';
                    const neededMatch = neededText.match(/Needed:\s*([\d,]+)/);
                    if (neededMatch) {
                        stockNeeded = parseInt(neededMatch[1].replace(/,/g, '')) || 0;
                    }
                }
                
                debugLog(`Business ${businessCode}: Product="${productName}", StockNeeded=${stockNeeded}`);
                
                // Initialize product in map if not exists
                if (!productMap[productName]) {
                    productMap[productName] = {
                        productId: productId,
                        totalNeeded: 0,
                        businesses: []
                    };
                }
                
                // Add to total if stock needed > 0
                if (stockNeeded > 0) {
                    productMap[productName].totalNeeded += stockNeeded;
                }
                productMap[productName].businesses.push({
                    code: businessCode,
                    needed: stockNeeded
                });
            });
            
            debugLog(`Tier summary stats:`, { 
                tierName, 
                totalBusinesses: businesses.length, 
                checked: checkedCount, 
                skipped: skippedCount, 
                processed: processedCount,
                productsFound: Object.keys(productMap).length 
            });
            debugLog(`Product map:`, productMap);
            
            // Render summary table
            const summaryFooter = document.getElementById(`tier-summary-footer-${tierName}`);
            if (Object.keys(productMap).length === 0) {
                summaryBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No products selected yet</td></tr>';
                if (summaryFooter) {
                    summaryFooter.innerHTML = '';
                }
                debugLog(`No products found for tier ${tierName}`);
                calculateAllBusinessSummary();
                return;
            }
            
            // Calculate grand total
            let grandTotal = 0;
            const productNames = Object.keys(productMap);
            const sortedProducts = getProductsInOrder(productNames);
            
            summaryBody.innerHTML = sortedProducts.map(productName => {
                const productData = productMap[productName];
                const totalNeeded = productData.totalNeeded;
                grandTotal += totalNeeded;
                
                debugLog(`Product "${productName}": totalNeeded=${totalNeeded}`);
                
                return `
                    <tr>
                        <td>${escapeHtml(productName)}</td>
                        <td class="text-end">
                            <strong>${totalNeeded.toLocaleString('en-US')}</strong>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Render grand total footer
            if (summaryFooter) {
                summaryFooter.innerHTML = `
                    <tr style="background-color: rgba(102, 126, 234, 0.1);">
                        <td><strong>Grand Total</strong></td>
                        <td class="text-end"><strong style="font-size: 1.1em;">${grandTotal.toLocaleString('en-US')}</strong></td>
                    </tr>
                `;
            }
            
            debugLog(`Tier summary grand total for ${tierName}: ${grandTotal}`);
            debugLog(`=== calculateTierSummary END for tier: ${tierName} ===`);
            
            // Recalculate all business summary after tier summary is updated
            calculateAllBusinessSummary();
        }

        // Calculate all business summary (aggregates all tier summaries)
        function calculateAllBusinessSummary() {
            debugLog(`=== calculateAllBusinessSummary START ===`);
            const summaryCard = document.getElementById('allBusinessSummaryCard');
            const summaryBody = document.getElementById('allBusinessSummaryBody');
            const headerRow = document.getElementById('allBusinessSummaryHeaderRow');
            const summaryFooter = document.getElementById('allBusinessSummaryFooter');
            
            if (!summaryCard || !summaryBody || !headerRow || !summaryFooter) {
                debugWarn('All Business Summary elements not found');
                return;
            }
            
            // Aggregate product data from all tiers
            const allProductsMap = {}; // productName -> { tiers: { tierName: totalNeeded }, grandTotal: number }
            const tierNames = [];
            const tiers = getBusinessTiers();
            
            if (!tiers || tiers.length === 0) {
                debugLog('No tiers found, hiding summary card');
                summaryCard.style.display = 'none';
                return;
            }
            
            let totalChecked = 0;
            let totalProcessed = 0;
            let totalSkipped = 0;
            
            tiers.forEach(tier => {
                const tierName = tier.name;
                tierNames.push(tierName);
                
                // Get all businesses for this tier
                const businesses = document.querySelectorAll(`.business-item[data-tier="${tierName}"]`);
                debugLog(`Tier ${tierName}: Found ${businesses.length} businesses`);
                
                businesses.forEach(businessItem => {
                    const businessCode = businessItem.dataset.businessCode;
                    
                    // Check if business checkbox is checked - if checked, ignore this business
                    const businessCheckbox = businessItem.querySelector(`input[type="checkbox"][data-tier="${tierName}"][value="${businessCode}"]`);
                    if (businessCheckbox && businessCheckbox.checked) {
                        totalChecked++;
                        return;
                    }
                    
                    const productSelector = businessItem.querySelector(`.product-selector[data-tier="${tierName}"][data-business-code="${businessCode}"]`);
                    const stockNeededDisplay = document.getElementById(`stock-needed-${tierName}-${businessCode}`);
                    
                    if (!productSelector) {
                        totalSkipped++;
                        return;
                    }
                    
                    const selectedOption = productSelector.options[productSelector.selectedIndex];
                    if (!selectedOption || !selectedOption.value) {
                        totalSkipped++;
                        return;
                    }
                    
                    totalProcessed++;
                    const productName = selectedOption.textContent;
                    
                    // Get stock needed value
                    let stockNeeded = 0;
                    if (stockNeededDisplay) {
                        const neededText = stockNeededDisplay.textContent || '';
                        const neededMatch = neededText.match(/Needed:\s*([\d,]+)/);
                        if (neededMatch) {
                            stockNeeded = parseInt(neededMatch[1].replace(/,/g, '')) || 0;
                        }
                    }
                    
                    // Initialize product in map if not exists
                    if (!allProductsMap[productName]) {
                        allProductsMap[productName] = {
                            tiers: {},
                            grandTotal: 0
                        };
                    }
                    
                    // Initialize tier entry if not exists
                    if (!allProductsMap[productName].tiers[tierName]) {
                        allProductsMap[productName].tiers[tierName] = 0;
                    }
                    
                    // Add to tier total and grand total
                    if (stockNeeded > 0) {
                        allProductsMap[productName].tiers[tierName] += stockNeeded;
                        allProductsMap[productName].grandTotal += stockNeeded;
                    }
                });
            });
            
            debugLog(`All business summary stats:`, {
                totalTiers: tierNames.length,
                totalProducts: Object.keys(allProductsMap).length,
                totalChecked,
                totalProcessed,
                totalSkipped,
                overallGrandTotal: 0 // Will be calculated below
            });
            debugLog(`All products map:`, allProductsMap);
            
            // Check if there are any products
            if (Object.keys(allProductsMap).length === 0) {
                const colspan = tierNames.length + 2;
                summaryBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">No products selected yet</td></tr>`;
                summaryFooter.innerHTML = '';
                summaryCard.style.display = 'none';
                debugLog(`No products found across all tiers`);
                return;
            }
            
            // Show the summary card
            summaryCard.style.display = 'block';
            
            // Rebuild tier header columns
            const tierHeaderCells = tierNames.map(tierName => 
                `<th class="text-end">${escapeHtml(tierName)}</th>`
            ).join('');
            headerRow.innerHTML = `<th>Product Name</th>${tierHeaderCells}<th class="text-end"><strong>Grand Total</strong></th>`;
            
            // Build table rows
            const productNames = Object.keys(allProductsMap);
            const sortedProducts = getProductsInOrder(productNames);
            summaryBody.innerHTML = sortedProducts.map(productName => {
                const productData = allProductsMap[productName];
                const tierCells = tierNames.map(tierName => {
                    const tierTotal = productData.tiers[tierName] || 0;
                    return `<td class="text-end">${tierTotal > 0 ? tierTotal.toLocaleString('en-US') : '-'}</td>`;
                }).join('');
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(productName)}</strong></td>
                        ${tierCells}
                        <td class="text-end"><strong>${productData.grandTotal.toLocaleString('en-US')}</strong></td>
                    </tr>
                `;
            }).join('');
            
            // Calculate grand totals for each tier and overall
            const tierGrandTotals = {};
            let overallGrandTotal = 0;
            
            tierNames.forEach(tierName => {
                tierGrandTotals[tierName] = 0;
            });
            
            sortedProducts.forEach(productName => {
                const productData = allProductsMap[productName];
                tierNames.forEach(tierName => {
                    const tierTotal = productData.tiers[tierName] || 0;
                    tierGrandTotals[tierName] += tierTotal;
                });
                overallGrandTotal += productData.grandTotal;
            });
            
            // Build grand total footer row
            const tierGrandTotalCells = tierNames.map(tierName => {
                const total = tierGrandTotals[tierName];
                return `<td class="text-end"><strong>${total > 0 ? total.toLocaleString('en-US') : '-'}</strong></td>`;
            }).join('');
            
            summaryFooter.innerHTML = `
                <tr style="background-color: rgba(102, 126, 234, 0.1);">
                    <td><strong>Grand Total</strong></td>
                    ${tierGrandTotalCells}
                    <td class="text-end"><strong style="font-size: 1.1em;">${overallGrandTotal.toLocaleString('en-US')}</strong></td>
                </tr>
            `;
            
            debugLog(`All business summary complete:`, {
                totalTiers: tierNames.length,
                totalProducts: sortedProducts.length,
                overallGrandTotal
            });
            debugLog(`=== calculateAllBusinessSummary END ===`);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // How to Use Section Collapse State
        const HOW_TO_USE_STORAGE_KEY = 'checklist_how_to_use_expanded';
        
        // Initialize How to Use collapse state
        function initHowToUseCollapse() {
            const stored = localStorage.getItem(HOW_TO_USE_STORAGE_KEY);
            const shouldExpand = stored === null ? true : stored === 'true'; // Default to expanded
            
            const collapseElement = document.getElementById('howToUseCollapse');
            const toggleIcon = document.getElementById('howToUseToggle');
            const toggleButton = document.querySelector('[data-bs-target="#howToUseCollapse"]');
            
            if (collapseElement) {
                const bsCollapse = new bootstrap.Collapse(collapseElement, {
                    toggle: false
                });
                
                if (!shouldExpand) {
                    bsCollapse.hide();
                    if (toggleIcon) toggleIcon.textContent = 'â–¶';
                    if (toggleButton) toggleButton.setAttribute('aria-expanded', 'false');
                } else {
                    bsCollapse.show();
                    if (toggleIcon) toggleIcon.textContent = 'â–¼';
                    if (toggleButton) toggleButton.setAttribute('aria-expanded', 'true');
                }
                
                // Listen for collapse events
                collapseElement.addEventListener('shown.bs.collapse', function() {
                    localStorage.setItem(HOW_TO_USE_STORAGE_KEY, 'true');
                    if (toggleIcon) toggleIcon.textContent = 'â–¼';
                    if (toggleButton) toggleButton.setAttribute('aria-expanded', 'true');
                });
                
                collapseElement.addEventListener('hidden.bs.collapse', function() {
                    localStorage.setItem(HOW_TO_USE_STORAGE_KEY, 'false');
                    if (toggleIcon) toggleIcon.textContent = 'â–¶';
                    if (toggleButton) toggleButton.setAttribute('aria-expanded', 'false');
                });
            }
        }

        // Load businesses on page load
        window.addEventListener('DOMContentLoaded', async function() {
            initDebugMode();
            initHowToUseCollapse();
            debugLog('Page initialized');
            
            updateTimes();
            setInterval(updateTimes, 1000);
            
            // Initialize configuration (wait for it to complete)
            await initializeConfig();
            
            // Update storage UI
            updateStorageUI();
            
            // Load businesses (only after config is initialized)
            if (checklistConfigData) {
                await loadAllBusinesses();
            } else {
                debugError('Failed to initialize configuration');
                document.getElementById('loadingAlert').innerHTML = '<span class="text-danger">âš ï¸ Failed to initialize configuration. Please refresh the page or add tiers/businesses manually.</span>';
            }
        });
        
        // Also update on page load (in case DOMContentLoaded already fired)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                updateTimes();
                setInterval(updateTimes, 1000);
            });
        } else {
            updateTimes();
            setInterval(updateTimes, 1000);
            // If DOM already loaded, initialize immediately
            (async function() {
                await initializeConfig();
                if (checklistConfigData) {
                    loadAllBusinesses();
                }
            })();
        }
        
        // Calculate stock needed for checklist
        function calculateStockNeededChecklist(tierName, businessCode, maxStock) {
            const displayId = `stock-needed-${tierName}-${businessCode}`;
            const display = document.getElementById(displayId);
            const input = document.querySelector(`.stock-target-input[data-tier="${tierName}"][data-business-code="${businessCode}"]`);
            
            if (!display || !input) return;
            
            const currentValue = input.value.replace(/,/g, '');
            const current = parseFloat(currentValue) || 0;
            
            if (current === 0) {
                display.innerHTML = '<small class="text-muted">Enter current stock to calculate</small>';
                if (typeof saveProgress === 'function') {
                    saveProgress();
                }
                return;
            }
            
            // Validate: current cannot exceed max
            if (current > maxStock) {
                display.innerHTML = `<small class="text-danger"><strong>Error: Current (${current.toLocaleString('en-US')}) exceeds Max (${maxStock.toLocaleString('en-US')})</strong></small>`;
                return;
            }
            
            // Validate: current cannot be negative
            if (current < 0) {
                display.innerHTML = `<small class="text-danger"><strong>Error: Current cannot be negative</strong></small>`;
                return;
            }
            
            // Calculation: Max Stock - Current Stock = Needed
            const needed = maxStock - current;
            
            let displayText = '';
            if (needed === 0) {
                displayText = '<small style="font-weight: 700; color: #28a745;">âœ… Stock is full</small>';
            } else {
                displayText = `<small style="font-weight: 700; color: #11998e;"><strong>ğŸ“Š Needed: ${needed.toLocaleString('en-US')}</strong></small>`;
            }
            
            display.innerHTML = displayText;
            
            // Auto-save to localStorage only if value is valid
            if (typeof saveProgress === 'function') {
                saveProgress();
            }
            
            // Recalculate tier summary after stock calculation
            setTimeout(() => {
                debugLog(`Stock calculation triggered summary recalculation for tier: ${tierName}`);
                calculateTierSummary(tierName);
            }, 100);
        }

        // Tier Management Functions
        function openAddTierModal() {
            document.getElementById('tierModalLabel').textContent = 'Add Tier';
            document.getElementById('tierForm').reset();
            document.getElementById('tierId').value = '';
            document.getElementById('deleteTierBtn').style.display = 'none';
            const modalElement = document.getElementById('tierModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Ensure proper aria-hidden handling
            modalElement.addEventListener('shown.bs.modal', function() {
                modalElement.setAttribute('aria-hidden', 'false');
            }, { once: true });
            
            modal.show();
        }

        function openEditTierModal() {
            const tiers = checklistConfigData.tiers || [];
            if (tiers.length === 0) {
                alert('No tiers available to edit. Please add a tier first.');
                return;
            }
            
            const tierOptions = tiers.map(t => `${t.id}: ${t.name}`).join('\n');
            const tierId = prompt(`Enter Tier ID to edit:\n\n${tierOptions}`);
            if (!tierId) return;
            
            const tier = tiers.find(t => t.id === parseInt(tierId));
            if (!tier) {
                alert('Tier not found');
                return;
            }
            
            document.getElementById('tierModalLabel').textContent = 'Edit Tier';
            document.getElementById('tierId').value = tier.id;
            document.getElementById('tierName').value = tier.name;
            document.getElementById('tierIcon').value = tier.icon || '';
            document.getElementById('tierColor').value = tier.color || 'bg-secondary';
            document.getElementById('deleteTierBtn').style.display = 'inline-block';
            
            const modalElement = document.getElementById('tierModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Ensure proper aria-hidden handling
            modalElement.addEventListener('shown.bs.modal', function() {
                modalElement.setAttribute('aria-hidden', 'false');
            }, { once: true });
            
            modal.show();
        }

        function saveTier() {
            const id = document.getElementById('tierId').value;
            const name = document.getElementById('tierName').value;
            const icon = document.getElementById('tierIcon').value;
            const color = document.getElementById('tierColor').value;
            
            if (!name.trim()) {
                alert('Tier name is required');
                return;
            }
            
            if (!checklistConfigData.tiers) {
                checklistConfigData.tiers = [];
            }
            
            if (id) {
                // Edit existing tier
                const tierIndex = checklistConfigData.tiers.findIndex(t => t.id === parseInt(id));
                if (tierIndex !== -1) {
                    const originalTier = checklistConfigData.tiers[tierIndex];
                    const trimmedName = name.trim();
                    
                    // Check if new name conflicts with another tier (excluding current one)
                    if (trimmedName !== originalTier.name) {
                        const conflictingTier = checklistConfigData.tiers.find(
                            t => t.name.toLowerCase() === trimmedName.toLowerCase() && t.id !== parseInt(id)
                        );
                        if (conflictingTier) {
                            alert('Tier name already exists');
                            return;
                        }
                    }
                    
                    checklistConfigData.tiers[tierIndex] = {
                        id: parseInt(id),
                        name: trimmedName,
                        icon: icon.trim(),
                        color: color,
                        visible: true
                    };
                }
            } else {
                // Add new tier
                const trimmedName = name.trim();
                
                // Check if tier name already exists
                const existingTier = checklistConfigData.tiers.find(
                    t => t.name.toLowerCase() === trimmedName.toLowerCase()
                );
                if (existingTier) {
                    alert('Tier name already exists');
                    return;
                }
                
                const maxId = checklistConfigData.tiers.length > 0 
                    ? Math.max(...checklistConfigData.tiers.map(t => t.id))
                    : 0;
                checklistConfigData.tiers.push({
                    id: maxId + 1,
                    name: trimmedName,
                    icon: icon.trim(),
                    color: color,
                    visible: true
                });
            }
            
            saveConfigToLocalStorage();
            const tierModal = bootstrap.Modal.getInstance(document.getElementById('tierModal'));
            if (tierModal) {
                // Remove focus from any focused element before hiding
                const focusedElement = document.activeElement;
                if (focusedElement && tierModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                tierModal.hide();
            }
            // Defer reload to avoid blocking UI - use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
            loadAllBusinesses();
            });
        }

        function deleteTier() {
            const id = document.getElementById('tierId').value;
            if (!id) return;
            
            const tier = checklistConfigData.tiers.find(t => t.id === parseInt(id));
            const tierName = tier ? tier.name : 'this tier';
            const businessesInTier = (checklistConfigData.businesses || []).filter(b => b.tierId === parseInt(id));
            const businessCount = businessesInTier.length;
            
            // First confirmation
            if (!confirm(`âš ï¸ WARNING: You are about to delete "${tierName}".\n\nThis will PERMANENTLY delete:\n- The tier itself\n- ${businessCount} business${businessCount !== 1 ? 'es' : ''} in this tier\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            // Second confirmation (EXTRA confirmation)
            if (!confirm(`ğŸš¨ FINAL CONFIRMATION ğŸš¨\n\nYou are about to PERMANENTLY DELETE:\n- Tier: "${tierName}"\n- ${businessCount} business${businessCount !== 1 ? 'es' : ''}\n\nThis will remove ALL data associated with this tier.\n\nClick OK to proceed to the final confirmation step.`)) {
                return;
            }
            
            // Third confirmation - require typing confirmation phrase
            const confirmationPhrase = "I want to remove";
            const userInput = prompt(`ğŸš¨ TYPE TO CONFIRM DELETION ğŸš¨\n\nTo confirm deletion of:\n- Tier: "${tierName}"\n- ${businessCount} business${businessCount !== 1 ? 'es' : ''}\n\nPlease type exactly: "${confirmationPhrase}"\n\n(Click Cancel to abort)`);
            
            if (userInput === null) {
                return; // User clicked Cancel
            }
            
            if (userInput.trim() !== confirmationPhrase) {
                alert(`âŒ Confirmation failed!\n\nYou typed: "${userInput}"\n\nExpected: "${confirmationPhrase}"\n\nDeletion cancelled.`);
                return;
            }
            
            // Remove tier
            checklistConfigData.tiers = checklistConfigData.tiers.filter(t => t.id !== parseInt(id));
            
            // Remove businesses in this tier
            checklistConfigData.businesses = (checklistConfigData.businesses || []).filter(b => b.tierId !== parseInt(id));
            
            // Remove products in this tier
            checklistConfigData.products = (checklistConfigData.products || []).filter(p => p.tierId !== parseInt(id));
            
            saveConfigToLocalStorage();
            const tierModal = bootstrap.Modal.getInstance(document.getElementById('tierModal'));
            if (tierModal) {
                // Remove focus from any focused element before hiding
                const focusedElement = document.activeElement;
                if (focusedElement && tierModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                tierModal.hide();
            }
            // Defer reload to avoid blocking UI
            setTimeout(() => {
            loadAllBusinesses();
            }, 0);
            
            alert(`âœ… Tier "${tierName}" and ${businessCount} business${businessCount !== 1 ? 'es' : ''} have been deleted.`);
        }

        // Business Management Functions
        function openAddBusinessModal() {
            document.getElementById('businessModalLabel').textContent = 'Add Business';
            document.getElementById('businessForm').reset();
            document.getElementById('businessCodeOriginal').value = '';
            document.getElementById('deleteBusinessBtn').style.display = 'none';
            
            // Set default values for number inputs
            document.getElementById('businessMaxStock').value = '0';
            document.getElementById('businessCollectionStorage').value = '0';
            document.getElementById('businessNotes').value = '';
            
            // Populate tier dropdown
            const tierSelect = document.getElementById('businessTierId');
            tierSelect.innerHTML = '<option value="">Select a tier...</option>';
            (checklistConfigData.tiers || []).forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.id;
                option.textContent = tier.name;
                tierSelect.appendChild(option);
            });
            
            const modalElement = document.getElementById('businessModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Initialize number formatting and tooltips after modal is fully shown
            modalElement.addEventListener('shown.bs.modal', function() {
                if (typeof initNumberFormatting === 'function') {
                    initNumberFormatting({ allowDecimals: false, selector: '#businessMaxStock, #businessCollectionStorage' });
                }
                // Initialize Bootstrap tooltips
                const tooltipTriggerList = modalElement.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            }, { once: true });
            
            modal.show();
        }

        function openEditBusinessModal() {
            const businesses = checklistConfigData.businesses || [];
            if (businesses.length === 0) {
                alert('No businesses available to edit. Please add a business first.');
                return;
            }
            
            // Use setTimeout to defer the prompt and avoid blocking the click handler
            setTimeout(() => {
                // Limit the number of businesses shown in prompt to avoid performance issues
                const maxDisplay = 50;
                const displayBusinesses = businesses.slice(0, maxDisplay);
                const remainingCount = businesses.length - maxDisplay;
                
                let businessOptions = displayBusinesses.map(b => `${b.businessCode}: ${b.businessName}`).join('\n');
                if (remainingCount > 0) {
                    businessOptions += `\n\n... and ${remainingCount} more business${remainingCount !== 1 ? 'es' : ''}`;
                }
                
            const businessCode = prompt(`Enter Business Code to edit:\n\n${businessOptions}`);
            if (!businessCode) return;
            
            const business = businesses.find(b => b.businessCode === businessCode.trim());
            if (!business) {
                alert('Business not found');
                return;
            }
            
                // Populate form fields
            document.getElementById('businessModalLabel').textContent = 'Edit Business';
            document.getElementById('businessCodeOriginal').value = business.businessCode;
            document.getElementById('businessCode').value = business.businessCode;
            document.getElementById('businessName').value = business.businessName;
            document.getElementById('businessStatus').value = business.status || 'Open';
                
                // Format numbers with commas for display
                const maxStock = business.maxStock || 0;
                const collectionStorage = business.collectionStorage || 0;
                document.getElementById('businessMaxStock').value = typeof formatNumber === 'function' ? formatNumber(maxStock, false) : maxStock.toString();
                document.getElementById('businessCollectionStorage').value = typeof formatNumber === 'function' ? formatNumber(collectionStorage, false) : collectionStorage.toString();
                
            document.getElementById('businessCanCollectItems').checked = business.canCollectItems === true;
            document.getElementById('businessNotes').value = business.notes || '';
                
            document.getElementById('deleteBusinessBtn').style.display = 'inline-block';
            
                // Populate tier dropdown efficiently
            const tierSelect = document.getElementById('businessTierId');
                const tiers = checklistConfigData.tiers || [];
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a tier...';
                fragment.appendChild(defaultOption);
                
                tiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.id;
                option.textContent = tier.name;
                    if (tier.id === business.tierId) {
                        option.selected = true;
                    }
                    fragment.appendChild(option);
                });
                
                tierSelect.innerHTML = '';
                tierSelect.appendChild(fragment);
                
                // Show modal
                const modalElement = document.getElementById('businessModal');
                const modal = new bootstrap.Modal(modalElement);
                
                // Initialize number formatting and tooltips after modal is fully shown
                modalElement.addEventListener('shown.bs.modal', function() {
                    if (typeof initNumberFormatting === 'function') {
                        initNumberFormatting({ allowDecimals: false, selector: '#businessMaxStock, #businessCollectionStorage' });
                    }
                    // Initialize Bootstrap tooltips
                    const tooltipTriggerList = modalElement.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
                }, { once: true });
                
            modal.show();
            }, 0);
        }

        function saveBusiness() {
            const originalCode = document.getElementById('businessCodeOriginal').value;
            const code = document.getElementById('businessCode').value.trim();
            const name = document.getElementById('businessName').value.trim();
            const tierId = document.getElementById('businessTierId').value;
            const status = document.getElementById('businessStatus').value;
            
            // Parse formatted numbers (remove commas)
            const maxStockValue = document.getElementById('businessMaxStock').value;
            const collectionStorageValue = document.getElementById('businessCollectionStorage').value;
            const maxStock = typeof parseFormattedNumber === 'function' 
                ? parseFormattedNumber(maxStockValue) 
                : parseInt(maxStockValue.replace(/,/g, '')) || 0;
            const collectionStorage = typeof parseFormattedNumber === 'function' 
                ? parseFormattedNumber(collectionStorageValue) 
                : parseInt(collectionStorageValue.replace(/,/g, '')) || 0;
            
            const canCollectItems = document.getElementById('businessCanCollectItems').checked;
            const notes = document.getElementById('businessNotes').value.trim();
            
            if (!code || !name || !tierId) {
                alert('Business code, name, and tier are required');
                return;
            }
            
            if (!checklistConfigData.businesses) {
                checklistConfigData.businesses = [];
            }
            
            if (originalCode) {
                // Edit existing business
                const businessIndex = checklistConfigData.businesses.findIndex(b => b.businessCode === originalCode);
                if (businessIndex !== -1) {
                    // Check if new code conflicts with another business (excluding current one)
                    if (code !== originalCode) {
                        const conflictingBusiness = checklistConfigData.businesses.find(
                            b => b.businessCode === code && b.businessCode !== originalCode
                        );
                        if (conflictingBusiness) {
                            alert('Business code already exists');
                            return;
                        }
                    }
                    
                    checklistConfigData.businesses[businessIndex] = {
                        businessCode: code,
                        businessName: name,
                        tierId: parseInt(tierId),
                        status: status,
                        maxStock: maxStock,
                        collectionStorage: collectionStorage,
                        canCollectItems: canCollectItems,
                        notes: notes
                    };
                }
            } else {
                // Add new business
                // Check if code already exists
                if (checklistConfigData.businesses.find(b => b.businessCode === code)) {
                    alert('Business code already exists');
                    return;
                }
                
                checklistConfigData.businesses.push({
                    businessCode: code,
                    businessName: name,
                    tierId: parseInt(tierId),
                    status: status,
                    maxStock: maxStock,
                    collectionStorage: collectionStorage,
                    canCollectItems: canCollectItems
                });
            }
            
            saveConfigToLocalStorage();
            const businessModal = bootstrap.Modal.getInstance(document.getElementById('businessModal'));
            if (businessModal) {
                // Remove focus from any focused element before hiding
                const focusedElement = document.activeElement;
                if (focusedElement && businessModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                businessModal.hide();
            }
            // Defer reload to avoid blocking UI - use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
            loadAllBusinesses();
            });
        }

        function deleteBusiness() {
            const code = document.getElementById('businessCodeOriginal').value;
            if (!code) return;
            
            const business = checklistConfigData.businesses.find(b => b.businessCode === code);
            const businessName = business ? business.businessName : code;
            
            // First confirmation
            if (!confirm(`âš ï¸ WARNING: You are about to delete business "${businessName}" (${code}).\n\nThis will PERMANENTLY delete:\n- Business code: ${code}\n- Business name: ${businessName}\n- All associated data\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            // Second confirmation (EXTRA confirmation)
            if (!confirm(`ğŸš¨ FINAL CONFIRMATION ğŸš¨\n\nYou are about to PERMANENTLY DELETE:\n- Business Code: ${code}\n- Business Name: ${businessName}\n\nThis will remove ALL data for this business.\n\nClick OK to proceed to the final confirmation step.`)) {
                return;
            }
            
            // Third confirmation - require typing confirmation phrase
            const confirmationPhrase = "I want to remove";
            const userInput = prompt(`ğŸš¨ TYPE TO CONFIRM DELETION ğŸš¨\n\nTo confirm deletion of:\n- Business Code: ${code}\n- Business Name: ${businessName}\n\nPlease type exactly: "${confirmationPhrase}"\n\n(Click Cancel to abort)`);
            
            if (userInput === null) {
                return; // User clicked Cancel
            }
            
            if (userInput.trim() !== confirmationPhrase) {
                alert(`âŒ Confirmation failed!\n\nYou typed: "${userInput}"\n\nExpected: "${confirmationPhrase}"\n\nDeletion cancelled.`);
                return;
            }
            
            checklistConfigData.businesses = (checklistConfigData.businesses || []).filter(b => b.businessCode !== code);
            saveConfigToLocalStorage();
            const businessModal = bootstrap.Modal.getInstance(document.getElementById('businessModal'));
            if (businessModal) {
                // Remove focus from any focused element before hiding
                const focusedElement = document.activeElement;
                if (focusedElement && businessModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                businessModal.hide();
            }
            // Defer reload to avoid blocking UI - use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
            loadAllBusinesses();
            });
            
            alert(`âœ… Business "${businessName}" (${code}) has been deleted.`);
        }

        // Product Management Functions
        function openAddProductModal() {
            debugLog('Opening Add Product Modal');
            document.getElementById('productModalLabel').textContent = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('deleteProductBtn').style.display = 'none';
            
            // Populate tier dropdown
            const tierSelect = document.getElementById('productTierId');
            tierSelect.innerHTML = '<option value="">Select a tier...</option>';
            const tiers = checklistConfigData.tiers || [];
            tiers.forEach(tier => {
                const option = document.createElement('option');
                option.value = tier.id;
                option.textContent = tier.name;
                tierSelect.appendChild(option);
            });
            debugLog(`Populated ${tiers.length} tiers in product modal`);
            
            const modalElement = document.getElementById('productModal');
            const modal = new bootstrap.Modal(modalElement);
            
            modalElement.addEventListener('shown.bs.modal', function() {
                modalElement.setAttribute('aria-hidden', 'false');
            }, { once: true });
            
            modal.show();
        }

        function openEditProductModal() {
            const products = checklistConfigData.products || [];
            debugLog(`Opening Edit Product Modal, ${products.length} products available`);
            if (products.length === 0) {
                alert('No products available to edit. Please add a product first.');
                return;
            }
            
            // Use setTimeout to defer the prompt
            setTimeout(() => {
                const maxDisplay = 50;
                const displayProducts = products.slice(0, maxDisplay);
                const remainingCount = products.length - maxDisplay;
                
                let productOptions = displayProducts.map(p => {
                    const tier = (checklistConfigData.tiers || []).find(t => t.id === p.tierId);
                    const tierName = tier ? tier.name : 'Unknown';
                    return `${p.id}: ${p.productName} (${tierName})`;
                }).join('\n');
                
                if (remainingCount > 0) {
                    productOptions += `\n\n... and ${remainingCount} more product${remainingCount !== 1 ? 's' : ''}`;
                }
                
                const productId = prompt(`Enter Product ID to edit:\n\n${productOptions}`);
                if (!productId) {
                    debugLog('Product edit cancelled by user');
                    return;
                }
                
                const product = products.find(p => p.id === parseInt(productId));
                if (!product) {
                    debugWarn(`Product not found: ${productId}`);
                    alert('Product not found');
                    return;
                }
                
                debugLog(`Editing product:`, { id: product.id, name: product.productName, tierId: product.tierId });
                document.getElementById('productModalLabel').textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.productName || '';
                document.getElementById('deleteProductBtn').style.display = 'inline-block';
                
                // Populate tier dropdown
                const tierSelect = document.getElementById('productTierId');
                const tiers = checklistConfigData.tiers || [];
                
                const fragment = document.createDocumentFragment();
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a tier...';
                fragment.appendChild(defaultOption);
                
                tiers.forEach(tier => {
                    const option = document.createElement('option');
                    option.value = tier.id;
                    option.textContent = tier.name;
                    if (tier.id === product.tierId) {
                        option.selected = true;
                    }
                    fragment.appendChild(option);
                });
                
                tierSelect.innerHTML = '';
                tierSelect.appendChild(fragment);
                
                const modalElement = document.getElementById('productModal');
                const modal = new bootstrap.Modal(modalElement);
                
                modalElement.addEventListener('shown.bs.modal', function() {
                    modalElement.setAttribute('aria-hidden', 'false');
                }, { once: true });
                
                modal.show();
            }, 0);
        }

        function saveProduct() {
            const id = document.getElementById('productId').value;
            const tierId = document.getElementById('productTierId').value;
            const productName = document.getElementById('productName').value.trim();
            
            debugLog('Saving product:', { id, tierId, productName });
            
            if (!tierId || !productName) {
                debugWarn('Product save failed: Tier and product name are required');
                alert('Tier and product name are required');
                return;
            }
            
            if (!checklistConfigData.products) {
                checklistConfigData.products = [];
            }
            
            if (id) {
                // Edit existing product
                debugLog(`Updating existing product ID: ${id}`);
                const productIndex = checklistConfigData.products.findIndex(p => p.id === parseInt(id));
                if (productIndex !== -1) {
                    const oldProduct = checklistConfigData.products[productIndex];
                    // Check if product name conflicts with another product in the same tier (excluding current one)
                    const conflictingProduct = checklistConfigData.products.find(
                        p => p.productName.toLowerCase() === productName.toLowerCase() && 
                             p.tierId === parseInt(tierId) && 
                             p.id !== parseInt(id)
                    );
                    if (conflictingProduct) {
                        debugWarn(`Product name conflict: "${productName}" already exists for tier ${tierId}`);
                        alert('Product name already exists for this tier');
                        return;
                    }
                    
                    checklistConfigData.products[productIndex] = {
                        id: parseInt(id),
                        tierId: parseInt(tierId),
                        productName: productName
                    };
                    debugLog(`âœ… Updated product:`, { 
                        id: parseInt(id), 
                        oldName: oldProduct.productName, 
                        newName: productName,
                        oldTierId: oldProduct.tierId,
                        newTierId: parseInt(tierId)
                    });
                } else {
                    debugWarn(`Product index not found for ID: ${id}`);
                }
            } else {
                // Add new product
                debugLog('Creating new product');
                // Check if product name already exists for this tier
                const existingProduct = checklistConfigData.products.find(
                    p => p.productName.toLowerCase() === productName.toLowerCase() && 
                         p.tierId === parseInt(tierId)
                );
                if (existingProduct) {
                    debugWarn(`Product name already exists for tier ${tierId}: "${productName}"`);
                    alert('Product name already exists for this tier');
                    return;
                }
                
                const maxId = checklistConfigData.products.length > 0 
                    ? Math.max(...checklistConfigData.products.map(p => p.id))
                    : 0;
                const newProductId = maxId + 1;
                checklistConfigData.products.push({
                    id: newProductId,
                    tierId: parseInt(tierId),
                    productName: productName
                });
                debugLog(`âœ… Created product with ID: ${newProductId}`, { id: newProductId, tierId: parseInt(tierId), productName });
            }
            
            saveConfigToLocalStorage();
            debugLog(`âœ… Saved ${checklistConfigData.products.length} products to config`);
            const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (productModal) {
                const focusedElement = document.activeElement;
                if (focusedElement && productModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                productModal.hide();
            }
            requestAnimationFrame(() => {
                loadAllBusinesses();
            });
        }

        function deleteProduct() {
            const id = document.getElementById('productId').value;
            if (!id) {
                debugWarn('Delete product called but no ID provided');
                return;
            }
            
            debugLog('Deleting product:', id);
            const product = checklistConfigData.products.find(p => p.id === parseInt(id));
            debugLog('Product to delete:', product);
            
            const productName = product ? product.productName : 'this product';
            const tier = product ? (checklistConfigData.tiers || []).find(t => t.id === product.tierId) : null;
            const tierName = tier ? tier.name : 'Unknown';
            
            // Check if any businesses are using this product
            const businessesUsingProduct = (checklistConfigData.businesses || []).filter(b => b.productId === parseInt(id));
            const businessCount = businessesUsingProduct.length;
            debugLog(`Found ${businessCount} businesses using this product`);
            
            if (businessCount > 0) {
                debugWarn(`Cannot delete product ${id}: ${businessCount} businesses are using it`, businessesUsingProduct.map(b => b.businessCode));
                if (!confirm(`âš ï¸ WARNING: You cannot delete "${productName}" because ${businessCount} business${businessCount !== 1 ? 'es are' : ' is'} using it.\n\nPlease remove the product selection from those businesses first.`)) {
                    return;
                }
                return;
            }
            
            // First confirmation
            if (!confirm(`âš ï¸ WARNING: You are about to delete product "${productName}" from ${tierName}.\n\nThis will PERMANENTLY delete this product.\n\nThis action CANNOT be undone!\n\nAre you sure you want to continue?`)) {
                return;
            }
            
            // Second confirmation
            if (!confirm(`ğŸš¨ FINAL CONFIRMATION ğŸš¨\n\nYou are about to PERMANENTLY DELETE:\n- Product: "${productName}"\n- Tier: ${tierName}\n\nClick OK to proceed to the final confirmation step.`)) {
                return;
            }
            
            // Third confirmation - require typing confirmation phrase
            const confirmationPhrase = "I want to remove";
            const userInput = prompt(`ğŸš¨ TYPE TO CONFIRM DELETION ğŸš¨\n\nTo confirm deletion of:\n- Product: "${productName}"\n- Tier: ${tierName}\n\nPlease type exactly: "${confirmationPhrase}"\n\n(Click Cancel to abort)`);
            
            if (userInput === null) {
                return;
            }
            
            if (userInput.trim() !== confirmationPhrase) {
                alert(`âŒ Confirmation failed!\n\nYou typed: "${userInput}"\n\nExpected: "${confirmationPhrase}"\n\nDeletion cancelled.`);
                return;
            }
            
            const productsBefore = checklistConfigData.products.length;
            checklistConfigData.products = (checklistConfigData.products || []).filter(p => p.id !== parseInt(id));
            const productsAfter = checklistConfigData.products.length;
            saveConfigToLocalStorage();
            debugLog(`âœ… Deleted product ID ${id}, ${productsBefore} -> ${productsAfter} products remaining`);
            const productModal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (productModal) {
                const focusedElement = document.activeElement;
                if (focusedElement && productModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                productModal.hide();
            }
            requestAnimationFrame(() => {
                loadAllBusinesses();
            });
            
            alert(`âœ… Product "${productName}" has been deleted.`);
        }

        // Product Helper Functions
        function getProductsForTier(tierId) {
            if (!checklistConfigData || !checklistConfigData.products) {
                debugLog(`No products config found for tier ${tierId}`);
                return [];
            }
            const products = checklistConfigData.products.filter(p => p.tierId === tierId);
            debugLog(`Found ${products.length} products for tier ${tierId}`);
            return products;
        }

        // Get products sorted by custom order (or alphabetical if no order set)
        function getProductsInOrder(productNames) {
            debugLog(`=== getProductsInOrder START ===`);
            debugLog(`Input product names:`, productNames);
            
            if (!checklistConfigData || !checklistConfigData.productOrder || checklistConfigData.productOrder.length === 0) {
                // No custom order, return alphabetically sorted
                const sorted = productNames.sort();
                debugLog(`No custom order found, using alphabetical order:`, sorted);
                debugLog(`=== getProductsInOrder END (alphabetical) ===`);
                return sorted;
            }
            
            const productOrder = checklistConfigData.productOrder;
            debugLog(`Custom product order found:`, productOrder);
            const orderedProducts = [];
            const unorderedProducts = [];
            
            // First, add products in the custom order
            productOrder.forEach(productId => {
                // Find product name by ID
                const product = (checklistConfigData.products || []).find(p => p.id === productId);
                if (product && productNames.includes(product.productName)) {
                    orderedProducts.push(product.productName);
                    debugLog(`Added ordered product: ${product.productName} (ID: ${productId})`);
                } else if (product) {
                    debugLog(`Skipped product ${product.productName} (ID: ${productId}) - not in productNames list`);
                }
            });
            
            // Then add any products not in the order list (alphabetically)
            productNames.forEach(productName => {
                if (!orderedProducts.includes(productName)) {
                    unorderedProducts.push(productName);
                }
            });
            unorderedProducts.sort();
            debugLog(`Found ${unorderedProducts.length} unordered products:`, unorderedProducts);
            
            const finalOrder = [...orderedProducts, ...unorderedProducts];
            debugLog(`Final product order:`, finalOrder);
            debugLog(`=== getProductsInOrder END (custom order) ===`);
            return finalOrder;
        }

        function populateProductSelectorsForTier(tierName) {
            debugLog(`Populating product selectors for tier: ${tierName}`);
            const tier = (checklistConfigData.tiers || []).find(t => t.name === tierName);
            if (!tier) {
                debugWarn(`Tier not found: ${tierName}`);
                return;
            }
            
            const products = getProductsForTier(tier.id);
            const selectors = document.querySelectorAll(`.product-selector[data-tier="${tierName}"]`);
            debugLog(`Found ${selectors.length} selectors for tier ${tierName}, populating with ${products.length} products`);
            
            selectors.forEach((selector, index) => {
                selector.innerHTML = '<option value="">-- Select Product --</option>';
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.productName;
                    option.dataset.productName = product.productName;
                    selector.appendChild(option);
                });
                debugLog(`Populated selector ${index + 1}/${selectors.length} for business: ${selector.dataset.businessCode}`);
            });
        }

        function handleProductSelection(tierName, businessCode) {
            const selector = document.querySelector(`.product-selector[data-tier="${tierName}"][data-business-code="${businessCode}"]`);
            if (!selector) {
                debugWarn(`Product selector not found for ${businessCode} in ${tierName}`);
                return;
            }
            
            const productId = selector.value ? parseInt(selector.value) : null;
            const selectedProduct = selector.options[selector.selectedIndex].text;
            debugLog(`Product selection changed:`, { tierName, businessCode, productId, productName: selectedProduct });
            
            // Save product selection to business object in config
            const business = (checklistConfigData.businesses || []).find(b => b.businessCode === businessCode);
            if (business) {
                const oldProductId = business.productId;
                business.productId = productId;
                debugLog(`Updated business product selection:`, { businessCode, oldProductId, newProductId: productId });
                saveConfigToLocalStorage();
            } else {
                debugWarn(`Business not found: ${businessCode}`);
            }
            
            // Recalculate tier summary
            debugLog(`Triggering tier summary recalculation for ${tierName}`);
            calculateTierSummary(tierName);
        }

        // Open product order modal
        function openProductOrderModal() {
            debugLog('=== openProductOrderModal START ===');
            const startTime = performance.now();
            const products = checklistConfigData.products || [];
            debugLog(`Found ${products.length} total products`);
            
            if (products.length === 0) {
                debugWarn('No products available for ordering');
                alert('No products available. Please add products first.');
                debugLog('=== openProductOrderModal END (no products) ===');
                return;
            }
            
            // Build product list with current order
            const productOrderList = document.getElementById('productOrderList');
            if (!productOrderList) {
                debugError('Product order list element not found');
                return;
            }
            productOrderList.innerHTML = '';
            debugLog('Cleared product order list');
            
            // Get products in current order (or alphabetical)
            const productOrder = checklistConfigData.productOrder || [];
            debugLog(`Current product order:`, productOrder);
            const orderedProducts = [];
            const unorderedProducts = [];
            const tiers = checklistConfigData.tiers || [];
            debugLog(`Found ${tiers.length} tiers for product lookup`);
            
            // Separate ordered and unordered products
            debugLog(`Processing ${productOrder.length} ordered product IDs`);
            productOrder.forEach((productId, idx) => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const tier = tiers.find(t => t.id === product.tierId);
                    const tierName = tier ? tier.name : 'Unknown';
                    orderedProducts.push({
                        ...product,
                        tierName: tierName
                    });
                    debugLog(`[${idx + 1}/${productOrder.length}] Added ordered product: ${product.productName} (ID: ${productId}, Tier: ${tierName})`);
                } else {
                    debugWarn(`Product ID ${productId} in order but not found in products list`);
                }
            });
            
            debugLog(`Processing ${products.length} total products for unordered items`);
            products.forEach((product, idx) => {
                if (!productOrder.includes(product.id)) {
                    const tier = tiers.find(t => t.id === product.tierId);
                    const tierName = tier ? tier.name : 'Unknown';
                    unorderedProducts.push({
                        ...product,
                        tierName: tierName
                    });
                    debugLog(`[${idx + 1}/${products.length}] Added unordered product: ${product.productName} (ID: ${product.id}, Tier: ${tierName})`);
                }
            });
            
            // Sort unordered products alphabetically
            const sortStartTime = performance.now();
            unorderedProducts.sort((a, b) => a.productName.localeCompare(b.productName));
            debugLog(`Found ${unorderedProducts.length} unordered products (sorted alphabetically in ${(performance.now() - sortStartTime).toFixed(2)}ms)`);
            
            // Combine ordered and unordered
            const allProducts = [...orderedProducts, ...unorderedProducts];
            debugLog(`Total products to display: ${allProducts.length}`, {
                ordered: orderedProducts.length,
                unordered: unorderedProducts.length,
                orderedProducts: orderedProducts.map(p => p.productName),
                unorderedProducts: unorderedProducts.map(p => p.productName)
            });
            
            // Use requestAnimationFrame to batch DOM updates for better performance
            requestAnimationFrame(() => {
                const renderStartTime = performance.now();
                debugLog(`Starting DOM rendering for ${allProducts.length} products`);
                
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();
                
                allProducts.forEach((product, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.dataset.productId = product.id;
                    item.innerHTML = `
                        <div class="flex-grow-1">
                            <strong>${escapeHtml(product.productName)}</strong>
                            <small class="text-muted d-block">Tier: ${escapeHtml(product.tierName)}</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveProductUp(${product.id})" ${index === 0 ? 'disabled' : ''} title="Move up">
                                â¬†ï¸
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveProductDown(${product.id})" ${index === allProducts.length - 1 ? 'disabled' : ''} title="Move down">
                                â¬‡ï¸
                            </button>
                        </div>
                    `;
                    fragment.appendChild(item);
                });
                
                productOrderList.appendChild(fragment);
                const renderTime = performance.now() - renderStartTime;
                debugLog(`Rendered ${allProducts.length} product items in modal (took ${renderTime.toFixed(2)}ms)`);
                
                // Show modal after DOM is ready
                setTimeout(() => {
                    const modalElement = document.getElementById('productOrderModal');
                    if (!modalElement) {
                        debugError('Product order modal element not found');
                        return;
                    }
                    
                    // Reuse existing modal instance if available
                    let modal = bootstrap.Modal.getInstance(modalElement);
                    if (!modal) {
                        debugLog('Creating new Bootstrap Modal instance');
                        modal = new bootstrap.Modal(modalElement);
                    } else {
                        debugLog('Reusing existing Bootstrap Modal instance');
                    }
                    
                    modalElement.addEventListener('shown.bs.modal', function() {
                        modalElement.setAttribute('aria-hidden', 'false');
                        const totalTime = performance.now() - startTime;
                        debugLog(`Modal shown successfully (total time: ${totalTime.toFixed(2)}ms)`);
                    }, { once: true });
                    
                    modal.show();
                    const totalTime = performance.now() - startTime;
                    debugLog(`=== openProductOrderModal END (total time: ${totalTime.toFixed(2)}ms) ===`);
                }, 0);
            });
        }
        
        // Move product up in order
        function moveProductUp(productId) {
            debugLog(`=== moveProductUp START ===`);
            debugLog(`Moving product ID ${productId} up`);
            const items = Array.from(document.querySelectorAll('#productOrderList .list-group-item'));
            const currentIndex = items.findIndex(item => parseInt(item.dataset.productId) === productId);
            debugLog(`Current index: ${currentIndex}, Total items: ${items.length}`);
            
            if (currentIndex > 0) {
                const productOrderList = document.getElementById('productOrderList');
                const item = items[currentIndex];
                const previousItem = items[currentIndex - 1];
                const productName = item.querySelector('strong')?.textContent || 'Unknown';
                
                productOrderList.insertBefore(item, previousItem);
                debugLog(`Moved product "${productName}" from index ${currentIndex} to ${currentIndex - 1}`);
                
                // Update button states
                updateProductOrderButtons();
            } else {
                debugLog(`Product ${productId} is already at the top, cannot move up`);
            }
            debugLog(`=== moveProductUp END ===`);
        }
        
        // Move product down in order
        function moveProductDown(productId) {
            debugLog(`=== moveProductDown START ===`);
            debugLog(`Moving product ID ${productId} down`);
            const items = Array.from(document.querySelectorAll('#productOrderList .list-group-item'));
            const currentIndex = items.findIndex(item => parseInt(item.dataset.productId) === productId);
            debugLog(`Current index: ${currentIndex}, Total items: ${items.length}`);
            
            if (currentIndex < items.length - 1) {
                const productOrderList = document.getElementById('productOrderList');
                const item = items[currentIndex];
                const nextItem = items[currentIndex + 1];
                const productName = item.querySelector('strong')?.textContent || 'Unknown';
                
                productOrderList.insertBefore(item, nextItem.nextSibling);
                debugLog(`Moved product "${productName}" from index ${currentIndex} to ${currentIndex + 1}`);
                
                // Update button states
                updateProductOrderButtons();
            } else {
                debugLog(`Product ${productId} is already at the bottom, cannot move down`);
            }
            debugLog(`=== moveProductDown END ===`);
        }
        
        // Update button states in product order modal
        function updateProductOrderButtons() {
            debugLog(`=== updateProductOrderButtons START ===`);
            const items = Array.from(document.querySelectorAll('#productOrderList .list-group-item'));
            debugLog(`Updating buttons for ${items.length} items`);
            
            let disabledUpCount = 0;
            let disabledDownCount = 0;
            
            items.forEach((item, index) => {
                const buttons = item.querySelectorAll('button');
                if (buttons.length >= 2) {
                    const wasUpDisabled = buttons[0].disabled;
                    const wasDownDisabled = buttons[1].disabled;
                    
                    buttons[0].disabled = index === 0; // Up button
                    buttons[1].disabled = index === items.length - 1; // Down button
                    
                    if (buttons[0].disabled) disabledUpCount++;
                    if (buttons[1].disabled) disabledDownCount++;
                    
                    if (wasUpDisabled !== buttons[0].disabled || wasDownDisabled !== buttons[1].disabled) {
                        const productName = item.querySelector('strong')?.textContent || 'Unknown';
                        debugLog(`Updated buttons for "${productName}" at index ${index}: Up=${buttons[0].disabled}, Down=${buttons[1].disabled}`);
                    }
                }
            });
            
            debugLog(`Button update complete: ${disabledUpCount} up buttons disabled, ${disabledDownCount} down buttons disabled`);
            debugLog(`=== updateProductOrderButtons END ===`);
        }
        
        // Save product order
        function saveProductOrder() {
            debugLog(`=== saveProductOrder START ===`);
            const items = Array.from(document.querySelectorAll('#productOrderList .list-group-item'));
            debugLog(`Found ${items.length} product items to save`);
            
            const productOrder = items.map(item => parseInt(item.dataset.productId));
            
            // Log product names in order for debugging
            const productNamesInOrder = items.map(item => {
                const productId = parseInt(item.dataset.productId);
                const product = (checklistConfigData.products || []).find(p => p.id === productId);
                return product ? product.productName : `Unknown (ID: ${productId})`;
            });
            debugLog(`Product order (by name):`, productNamesInOrder);
            debugLog(`Product order (by ID):`, productOrder);
            
            const oldOrder = checklistConfigData.productOrder || [];
            checklistConfigData.productOrder = productOrder;
            saveConfigToLocalStorage();
            debugLog(`âœ… Saved product order:`, {
                oldOrder: oldOrder,
                newOrder: productOrder,
                changed: JSON.stringify(oldOrder) !== JSON.stringify(productOrder)
            });
            
            // Close modal first, before recalculating
            const productOrderModal = bootstrap.Modal.getInstance(document.getElementById('productOrderModal'));
            if (productOrderModal) {
                debugLog('Closing product order modal');
                const focusedElement = document.activeElement;
                if (focusedElement && productOrderModal._element.contains(focusedElement)) {
                    focusedElement.blur();
                }
                
                // Remove any event listeners that might interfere
                const modalElement = document.getElementById('productOrderModal');
                modalElement.removeAttribute('aria-hidden');
                
                // Hide modal and wait for it to fully close
                productOrderModal.hide();
                
                // Wait for modal to fully close before continuing
                modalElement.addEventListener('hidden.bs.modal', function cleanup() {
                    modalElement.removeEventListener('hidden.bs.modal', cleanup);
                    debugLog('Product order modal fully closed, proceeding with updates');
                    
                    // Recalculate summaries with new order after modal is closed
                    debugLog(`Recalculating summaries for ${getBusinessTiers().length} tiers`);
                    const tiers = getBusinessTiers();
                    tiers.forEach(tier => {
                        debugLog(`Recalculating summary for tier: ${tier.name}`);
                        calculateTierSummary(tier.name);
                    });
                    
                    // Recalculate all business summary
                    debugLog('Recalculating all business summary');
                    calculateAllBusinessSummary();
                    
                    debugLog(`=== saveProductOrder END ===`);
                    
                    // Show success message after everything is done
                    setTimeout(() => {
                        alert('Product order saved! Summaries will update automatically.');
                    }, 100);
                }, { once: true });
            } else {
                debugWarn('Product order modal instance not found, proceeding without closing');
                
                // Recalculate summaries even if modal not found
                debugLog(`Recalculating summaries for ${getBusinessTiers().length} tiers`);
                const tiers = getBusinessTiers();
                tiers.forEach(tier => {
                    debugLog(`Recalculating summary for tier: ${tier.name}`);
                    calculateTierSummary(tier.name);
                });
                calculateAllBusinessSummary();
                
                debugLog(`=== saveProductOrder END ===`);
                alert('Product order saved! Summaries will update automatically.');
            }
        }
        
        // Sort products by tier in the modal
        function sortProductsByTier() {
            debugLog(`=== sortProductsByTier START ===`);
            const productOrderList = document.getElementById('productOrderList');
            const items = Array.from(document.querySelectorAll('#productOrderList .list-group-item'));
            debugLog(`Found ${items.length} product items to sort`);
            
            if (items.length === 0) {
                debugWarn('No products to sort');
                return;
            }
            
            // Get tier order from config
            const tiers = getBusinessTiers();
            debugLog(`Found ${tiers.length} tiers:`, tiers.map(t => t.name));
            
            // Create a map of tier name to tier index for sorting
            const tierOrderMap = {};
            tiers.forEach((tier, index) => {
                tierOrderMap[tier.name] = index;
                debugLog(`Tier "${tier.name}" at index ${index}`);
            });
            
            // Get all products with their data
            const products = checklistConfigData.products || [];
            const productsWithData = items.map(item => {
                const productId = parseInt(item.dataset.productId);
                const product = products.find(p => p.id === productId);
                const tier = tiers.find(t => t.id === product?.tierId);
                const tierName = tier ? tier.name : 'Unknown';
                const tierIndex = tierOrderMap[tierName] !== undefined ? tierOrderMap[tierName] : 999; // Unknown tiers go to end
                
                return {
                    item: item,
                    productId: productId,
                    productName: product ? product.productName : 'Unknown',
                    tierName: tierName,
                    tierIndex: tierIndex
                };
            });
            
            debugLog(`Products before sorting:`, productsWithData.map(p => ({
                name: p.productName,
                tier: p.tierName,
                tierIndex: p.tierIndex
            })));
            
            // Sort by tier index first, then alphabetically within each tier
            productsWithData.sort((a, b) => {
                if (a.tierIndex !== b.tierIndex) {
                    return a.tierIndex - b.tierIndex;
                }
                return a.productName.localeCompare(b.productName);
            });
            
            debugLog(`Products after sorting:`, productsWithData.map(p => ({
                name: p.productName,
                tier: p.tierName,
                tierIndex: p.tierIndex
            })));
            
            // Clear and rebuild the list
            productOrderList.innerHTML = '';
            
            // Group by tier for logging
            const productsByTier = {};
            productsWithData.forEach(p => {
                if (!productsByTier[p.tierName]) {
                    productsByTier[p.tierName] = [];
                }
                productsByTier[p.tierName].push(p.productName);
            });
            debugLog(`Products grouped by tier:`, productsByTier);
            
            // Re-append items in sorted order
            productsWithData.forEach((productData, index) => {
                const item = productData.item;
                const product = products.find(p => p.id === productData.productId);
                const tier = tiers.find(t => t.id === product?.tierId);
                const tierName = tier ? tier.name : 'Unknown';
                
                // Update button states
                const buttons = item.querySelectorAll('button');
                if (buttons.length >= 2) {
                    buttons[0].disabled = index === 0; // Up button
                    buttons[1].disabled = index === productsWithData.length - 1; // Down button
                }
                
                productOrderList.appendChild(item);
                debugLog(`Appended product "${productData.productName}" (Tier: ${tierName}) at index ${index}`);
            });
            
            debugLog(`âœ… Sorted ${items.length} products by tier`);
            debugLog(`=== sortProductsByTier END ===`);
        }
        
        // Reset product order to alphabetical
        function resetProductOrder() {
            debugLog(`=== resetProductOrder START ===`);
            const oldOrder = checklistConfigData.productOrder || [];
            debugLog(`Current product order:`, oldOrder);
            
            if (!confirm('Reset product order to alphabetical? This will remove your custom ordering.')) {
                debugLog('Reset cancelled by user');
                return;
            }
            
            checklistConfigData.productOrder = [];
            saveConfigToLocalStorage();
            debugLog('âœ… Reset product order to alphabetical', {
                oldOrder: oldOrder,
                newOrder: []
            });
            
            // Recalculate summaries
            debugLog(`Recalculating summaries for ${getBusinessTiers().length} tiers`);
            const tiers = getBusinessTiers();
            tiers.forEach(tier => {
                debugLog(`Recalculating summary for tier: ${tier.name}`);
                calculateTierSummary(tier.name);
            });
            
            // Refresh modal
            debugLog('Refreshing product order modal');
            openProductOrderModal();
            debugLog(`=== resetProductOrder END ===`);
        }

        // Import/Export Functions
        function exportConfiguration() {
            if (!checklistConfigData) {
                debugWarn('No configuration to export');
                alert('No configuration to export');
                return;
            }
            
            debugLog('Exporting configuration:', {
                tiers: checklistConfigData.tiers?.length || 0,
                businesses: checklistConfigData.businesses?.length || 0,
                products: checklistConfigData.products?.length || 0
            });
            
            const exportData = JSON.stringify(checklistConfigData, null, 2);
            document.getElementById('exportTextarea').value = exportData;
            document.getElementById('exportModalLabel').textContent = 'Export Configuration';
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }

        function openImportModal() {
            document.getElementById('importTextarea').value = '';
            const modal = new bootstrap.Modal(document.getElementById('importModal'));
            modal.show();
        }

        function importConfiguration() {
            debugLog('Starting configuration import');
            const importText = document.getElementById('importTextarea').value.trim();
            if (!importText) {
                debugWarn('Import cancelled: No text provided');
                alert('Please paste a configuration JSON string');
                return;
            }
            
            // Check if it looks like CSV (person table string) instead of JSON
            if (importText.startsWith('Business Code') || importText.includes(',') && !importText.trim().startsWith('{') && !importText.trim().startsWith('[')) {
                debugWarn('Import failed: CSV detected instead of JSON');
                alert('Error: This looks like a CSV (Person Table String), not JSON.\n\nPlease use "Export Configuration" to get the JSON format, or paste a valid JSON configuration.');
                return;
            }
            
            try {
                const imported = JSON.parse(importText);
                debugLog('Parsed import data:', { 
                    tiers: imported.tiers?.length || 0, 
                    businesses: imported.businesses?.length || 0,
                    products: imported.products?.length || 0 
                });
                
                // Validate structure
                if (!imported.tiers || !Array.isArray(imported.tiers)) {
                    throw new Error('Invalid structure: tiers array is required');
                }
                if (!imported.businesses || !Array.isArray(imported.businesses)) {
                    throw new Error('Invalid structure: businesses array is required');
                }
                
                // Validate tier structure
                imported.tiers.forEach((tier, index) => {
                    if (!tier.id || !tier.name) {
                        throw new Error(`Invalid tier at index ${index}: id and name are required`);
                    }
                });
                
                // Validate business structure
                imported.businesses.forEach((biz, index) => {
                    if (!biz.businessCode || !biz.businessName || biz.tierId === undefined) {
                        throw new Error(`Invalid business at index ${index}: businessCode, businessName, and tierId are required`);
                    }
                });
                
                // Validate products structure (if present)
                if (imported.products && Array.isArray(imported.products)) {
                    debugLog(`Validating ${imported.products.length} products`);
                    imported.products.forEach((prod, index) => {
                        if (!prod.id || !prod.tierId || !prod.productName) {
                            throw new Error(`Invalid product at index ${index}: id, tierId, and productName are required`);
                        }
                    });
                    debugLog(`âœ… Validated ${imported.products.length} products`);
                } else if (!imported.products) {
                    // Initialize products array if not present
                    debugLog('No products array found, initializing empty array');
                    imported.products = [];
                }
                
                // Initialize productOrder if not present
                if (!imported.productOrder || !Array.isArray(imported.productOrder)) {
                    debugLog('No productOrder array found, initializing empty array');
                    imported.productOrder = [];
                }
                
                checklistConfigData = imported;
                saveConfigToLocalStorage();
                debugLog(`âœ… Imported configuration:`, { 
                    tiers: checklistConfigData.tiers.length,
                    businesses: checklistConfigData.businesses.length,
                    products: checklistConfigData.products.length
                });
                const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                if (importModal) {
                    // Remove focus from any focused element before hiding
                    const focusedElement = document.activeElement;
                    if (focusedElement && importModal._element.contains(focusedElement)) {
                        focusedElement.blur();
                    }
                    importModal.hide();
                }
                alert('Configuration imported successfully!');
                // Defer reload to avoid blocking UI - use requestAnimationFrame for better performance
                requestAnimationFrame(() => {
                loadAllBusinesses();
                });
            } catch (error) {
                if (error instanceof SyntaxError) {
                    alert(`Import failed: Invalid JSON format.\n\nError: ${error.message}\n\nMake sure you are importing a JSON configuration, not a CSV (Person Table String).`);
                } else {
                    alert(`Import failed: ${error.message}`);
                }
                debugError('Import error:', error);
            }
        }

        function generatePersonTableString() {
            if (!checklistConfigData || !checklistConfigData.businesses) {
                alert('No businesses available');
                return;
            }
            
            // Generate CSV format for checklist with all business data
            let csv = 'Business Code,Business Name,Tier,Status,Max Stock,Collection Storage,Can Collect Items,Product,Notes\n';
            
            // Include all businesses regardless of status
            checklistConfigData.businesses.forEach(biz => {
                const tier = (checklistConfigData.tiers || []).find(t => t.id === biz.tierId);
                const tierName = tier ? tier.name : 'Unknown';
                const product = biz.productId ? (checklistConfigData.products || []).find(p => p.id === biz.productId) : null;
                const productName = product ? product.productName : '';
                
                // Properly escape CSV values (handle quotes and commas in business names)
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value);
                    if (str.includes('"') || str.includes(',') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };
                
                csv += `${escapeCSV(biz.businessCode)},${escapeCSV(biz.businessName)},${escapeCSV(tierName)},${escapeCSV(biz.status || 'Open')},${biz.maxStock || 0},${biz.collectionStorage || 0},${escapeCSV(biz.canCollectItems ? 'Yes' : 'No')},${escapeCSV(productName)},${escapeCSV(biz.notes || '')}\n`;
            });
            
            document.getElementById('exportTextarea').value = csv;
            document.getElementById('exportModalLabel').textContent = 'Generate Checklist (CSV)';
            const modal = new bootstrap.Modal(document.getElementById('exportModal'));
            modal.show();
        }

        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        // Toggle emoji picker visibility
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            if (picker.style.display === 'none') {
                picker.style.display = 'block';
                // Initialize search attributes on first open
                initializeEmojiSearch();
            } else {
                picker.style.display = 'none';
                // Clear search when closing
                const searchInput = document.getElementById('emojiSearchInput');
                if (searchInput) {
                    searchInput.value = '';
                    filterEmojis();
                }
            }
        }

        // Initialize emoji search attributes
        function initializeEmojiSearch() {
            const emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(btn => {
                if (!btn.hasAttribute('data-search')) {
                    const title = btn.getAttribute('title') || '';
                    const emoji = btn.textContent.trim();
                    // Create searchable text from title and emoji
                    const searchText = title.toLowerCase() + ' ' + emoji;
                    btn.setAttribute('data-search', searchText);
                }
            });
        }

        // Filter emojis based on search input
        function filterEmojis() {
            const searchInput = document.getElementById('emojiSearchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const emojiButtons = document.querySelectorAll('.emoji-btn');
            const categories = document.querySelectorAll('.emoji-category');
            const emojiGrids = document.querySelectorAll('.emoji-grid');
            
            if (searchTerm === '') {
                // Show all emojis and categories
                emojiButtons.forEach(btn => btn.classList.remove('hidden'));
                categories.forEach(cat => cat.classList.remove('hidden'));
                emojiGrids.forEach(grid => grid.classList.remove('hidden'));
                return;
            }
            
            // Filter emojis
            let visibleCount = 0;
            emojiButtons.forEach(btn => {
                const searchText = btn.getAttribute('data-search') || btn.getAttribute('title') || '';
                if (searchText.toLowerCase().includes(searchTerm)) {
                    btn.classList.remove('hidden');
                    visibleCount++;
                } else {
                    btn.classList.add('hidden');
                }
            });
            
            // Show/hide categories and grids based on visible emojis
            categories.forEach(category => {
                const categoryName = category.getAttribute('data-category');
                const categoryGrid = document.querySelector(`.emoji-grid[data-category="${categoryName}"]`);
                if (categoryGrid) {
                    const hasVisibleEmojis = Array.from(categoryGrid.querySelectorAll('.emoji-btn')).some(
                        btn => !btn.classList.contains('hidden')
                    );
                    if (hasVisibleEmojis) {
                        category.classList.remove('hidden');
                        categoryGrid.classList.remove('hidden');
                    } else {
                        category.classList.add('hidden');
                        categoryGrid.classList.add('hidden');
                    }
                }
            });
        }

        // Select emoji and insert into input
        function selectEmoji(emoji) {
            document.getElementById('tierIcon').value = emoji;
            // Optionally close the picker after selection
            // document.getElementById('emojiPicker').style.display = 'none';
        }
    </script>
</body>
</html>

